<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Attendance Tracker</title>
<link rel="icon" href="Facial_Recognition-removebg.png" />

<!-- Modern Attractive Theme -->
<style>
:root{
 --bg:#eef2ff;
 --card:#ffffff;
 --primary:#6366f1;
 --primary-dark:#4f46e5;
 --text:#111827;
 --muted:#6b7280;
 --danger:#ef4444;
 --success:#16a34a;
 --radius:14px;
 font-family:Inter, sans-serif;
}

body{
  background:linear-gradient(180deg,#eef2ff,#e0e7ff);
  margin:0;color:var(--text);
}

.container{
  max-width:960px;
  margin:32px auto;
  padding:16px;
}

/* CARD */
.card{
  background:var(--card);
  padding:20px;
  border-radius:var(--radius);
  box-shadow:0 6px 20px rgba(0,0,0,.08);
}

/* HEADER */
header{display:flex;gap:12px;align-items:center;margin-bottom:22px}
.logo{width:60px;height:60px;border-radius:14px;overflow:hidden;border:2px solid #c7d2fe;display:flex;align-items:center;justify-content:center;background:#fff}
.logo img{width:100%;height:100%;object-fit:contain}

/* ROLE BUTTONS */
.role-btn{
  background:var(--primary);
  color:white;
  padding:14px 18px;
  min-width:140px;    /* REDUCED */
  border-radius:12px;
  font-size:15px;
  font-weight:600;
}
.role-btn:hover{transform:scale(1.03);background:var(--primary-dark)}

/* TABS */
.tab-btn{
  padding:8px 14px;   /* REDUCED */
  background:#e0e7ff;
  border-radius:10px;
  margin-right:6px;
  font-size:14px;     /* REDUCED */
}
.tab-btn.active{
  background:var(--primary);
  color:#fff;
  transform:translateY(-2px);
}

/* BUTTONS */
.btn.primary{
  background:var(--primary);
  color:white;
  padding:8px 14px;     /* REDUCED */
  font-size:14px;
}
.btn.ghost{
  background:#f3f4f6;
  padding:8px 14px;
}
.btn.danger{
  background:var(--danger);
  color:white;
  padding:6px 12px;     /* REDUCED */
  font-size:13px;
  border-radius:10px;
}

/* INPUTS */
input,select{
  padding:8px 10px;      /* REDUCED */
  border-radius:10px;
  border:1px solid #d1d5db;
  font-size:14px;
  width:100%;
  max-width:260px;       /* LIMIT WIDTH */
}

input:focus,select:focus{outline:2px solid var(--primary)}

/* FORM ROW (Add student) */
.form-row{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.form-row > *{
  flex:1 1 auto;
  min-width:120px;       /* PREVENT shrinking too much */
}

/* TABLES */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:14px;
  font-size:14px;
}

th{
  background:#eef2ff;
  padding:10px;
  text-align:left;
}

td{
  padding:8px;           /* REDUCED */
  border-bottom:1px solid #e5e7eb;
}

table-wrapper{
  overflow-x:auto;       /* ENABLE HORIZONTAL SCROLL FOR MOBILE */
}

tr:hover{background:#f5f5ff}

.status-p{color:var(--success);font-weight:700}
.status-a{color:var(--danger);font-weight:700}

.hidden{display:none}
.flex{display:flex;gap:10px;align-items:center}
.right{margin-left:auto}

/* ---------- MOBILE RESPONSIVENESS ---------- */
@media(max-width:600px){

  .container{
    padding:10px;
    margin:10px;
  }

  .card{
    padding:16px;
  }

  header h1{
    font-size:20px;
    text-align:center;
  }

  .role-btn{
    width:100%;
    font-size:14px;
  }

  /* Tabs behaviour */
  .tab-btn{
    width:100%;
    margin-bottom:6px;
  }

  /* Inputs */
  input, select{
    width:100%;
    max-width:100%;    /* FULL WIDTH ON MOBILE */
  }

  .flex{
    flex-wrap:wrap;
  }

  .right{
    margin-left:0;
  }

  table{
    font-size:13px;
  }

  th,td{
    padding:8px;
  }

  /* Force table scroll so layout doesn't break */
  #mark-table-area, 
  #view-table-area, 
  #edit-table-area{
    overflow-x:auto;
  }
}
</style>
</head>
<body>
<div class="container">
<header>
 <div class="logo"><img src="Facial_Recognition-removebg.png" alt="logo"></div>
 <h1>Smart Attendance Tracker</h1>
</header>

<!-- HOME -->
<div id="home" class="card">
 <h2 style="text-align:center;margin-top:0">Welcome ‚Äî Choose Role</h2>
 <p style="text-align:center;color:var(--muted);margin-top:-4px">Use Student for personal view. Faculty will mark and manage attendance.</p>
 <div style="display:flex;gap:20px;justify-content:center;margin-top:20px;flex-wrap:wrap">
   <button id="btn-student" class="role-btn" onclick="openStudent()">Student</button>
   <button id="btn-faculty" class="role-btn" onclick="openFaculty()">Faculty</button>
 </div>
</div>

<!-- FACULTY LOGIN -->
<div id="faculty-login" class="card hidden">
 <div class="flex">
   <strong>Faculty Login</strong>
   <button class="btn ghost right" onclick="backHome()">‚¨Ö Back</button>
 </div>
 <div style="margin-top:12px">
   <label>Username</label>
   <input id="fac-user" placeholder="Enter username" />
 </div>
 <div style="margin-top:10px">
   <label>Password</label>
   <input id="fac-pass" type="password" placeholder="Enter password" />
 </div>
 <div class="flex" style="margin-top:14px">
   <button class="btn primary" onclick="facultyLogin()">Login</button>
   <button class="btn ghost" onclick="clearFaculty()">Clear</button>
 </div>
</div>
<!-- FACULTY DASHBOARD -->
<div id="faculty-dash" class="card hidden">
 <div class="flex" style="justify-content:space-between">
   <strong>Faculty Dashboard</strong>
   <button class="btn ghost" onclick="logoutFaculty()">Logout</button>
 </div>

 <div style="margin-top:14px">
   <button id="tab-mark" class="tab-btn" onclick="showSection('mark')">üìù Mark Attendance</button>
   <button id="tab-view" class="tab-btn" onclick="showSection('view')">üìä View Attendance</button>
   <button id="tab-edit" class="tab-btn" onclick="showSection('edit')">üë• Edit Students</button>
 </div>

 <!-- MARK -->
 <div id="section-mark" class="hidden" style="margin-top:18px">
   <div class="flex" style="align-items:center">
     <label>Choose Year:</label>
     <select id="mark-year" onchange="renderMarkTable()"><option value="1">1st</option><option value="2">2nd</option><option value="3">3rd</option></select>
     <span id="session-label" class="small" style="margin-left:8px"></span>
     <button id="save-marks" class="btn primary right" onclick="saveMarks()">Save</button>
   </div>
   <div id="mark-table-area"></div>
 </div>

 <!-- VIEW -->
<div id="section-view" class="hidden" style="margin-top:18px">
   <div class="flex">
      <label>Choose Year:</label>
      <select id="view-year" onchange="renderViewTable()">
         <option value="1">1st</option>
         <option value="2">2nd</option>
         <option value="3">3rd</option>
      </select>

      <!-- CSV EXPORT BUTTON ADDED -->
      <button class="btn primary right" onclick="exportCSV()">Download CSV</button>
   </div>

   <div id="view-table-area" style="margin-top:10px"></div>
</div>

 <!-- EDIT -->
 <div id="section-edit" class="hidden" style="margin-top:18px">
   <form id="add-student-form" onsubmit="event.preventDefault(); addStudentFromForm()">
     <div class="form-row" style="margin-top:8px">
       <input id="new-pin" type="text" class="pin-input" placeholder="PIN (e.g. 25183-CM-001)" required />
       <input id="new-name" type="text" placeholder="Student name" required />
       <select id="new-year"><option value="1">1st</option><option value="2">2nd</option><option value="3">3rd</option></select>
       <button class="btn primary" type="submit">Add</button>
     </div>
   </form>
   <div id="edit-table-area" style="margin-top:12px"></div>
 </div>
</div>

<!-- STUDENT -->
<div id="student-screen" class="card hidden" style="margin-top:16px">
 <div class="flex"><strong>Enter PIN</strong><button class="btn ghost right" onclick="backHome()">Back</button></div>
 <div class="flex" style="margin-top:14px">
   <input id="student-pin-input" placeholder="25183-CM-001" />
   <button class="btn primary" onclick="studentLookup()">Go</button>
 </div>
 <div id="student-result" style="margin-top:14px"></div>
</div>

</div>

<!-- ========== JAVASCRIPT ========== -->
<script>
/* single-file data + logic */
/* STORAGE KEY */
const STORAGE_KEY = 'smartStudents_final_v3';

/* --------- helpers --------- */
function el(id){ return document.getElementById(id); }

/* load/save localStorage (kept for sync and offline) */
function loadData(){ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { students: [], attendance: {} }; }
function saveDataLocal(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

/* When we push to Firebase we'll call pushDataToFirebase(d) if available.
   pushDataToFirebase is provided by the module below and is non-blocking.
*/
function saveData(d){
  // update localStorage first for immediate UI responsiveness
  saveDataLocal(d);
  // if firebase push is available, call it (don't await)
  if(window.pushDataToFirebase) {
    try {
      window.pushDataToFirebase(d);
    } catch(e){
      console.warn('Firebase push failed', e);
    }
  }
}

/* year prefix helpers: first year uses current year's last two digits */
function yearPrefixFor(year){
  const currentTwo = new Date().getFullYear() % 100; // e.g., 2025 -> 25
  if(year === 1) return currentTwo;
  if(year === 2) return currentTwo - 1;
  return currentTwo - 2;
}

/* seed example data if empty -- use dynamic prefix so 1st-year examples use current-year */
function seedIfEmpty(){
  if(localStorage.getItem(STORAGE_KEY)) return;
  const p1 = `${String(yearPrefixFor(1)).padStart(2,'0')}183-CM-001`;
  const p2 = `${String(yearPrefixFor(1)).padStart(2,'0')}183-CM-002`;
  const p3 = `${String(yearPrefixFor(2)).padStart(2,'0')}183-CM-001`;
  const p4 = `${String(yearPrefixFor(2)).padStart(2,'0')}183-CM-002`;
  const p5 = `${String(yearPrefixFor(3)).padStart(2,'0')}183-CM-001`;
  const data = {
    students: [
      { pin: p1, name: 'Ravi Kumar', year: 1 },
      { pin: p2, name: 'Sita Reddy', year: 1 },
      { pin: p3, name: 'Anil Shah', year: 2 },
      { pin: p4, name: 'Geeta Devi', year: 2 },
      { pin: p5, name: 'Mohan Das', year: 3 }
    ],
    attendance: {}
  };
  saveData(data);
}
seedIfEmpty();

/* --------- navigation / UI --------- */
function hideAll(){ document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden')); }
function backHome(){ hideAll(); el('home').classList.remove('hidden'); clearActiveTabs(); }
function openStudent(){ hideAll(); el('student-screen').classList.remove('hidden'); }
function openFaculty(){ hideAll(); el('faculty-login').classList.remove('hidden'); }

/* ensure both role buttons same color initially */
try {
  el('btn-student').style.background = getComputedStyle(document.documentElement).getPropertyValue('--primary');
  el('btn-student').style.color = '#fff';
  el('btn-faculty').style.background = getComputedStyle(document.documentElement).getPropertyValue('--primary');
  el('btn-faculty').style.color = '#fff';
} catch(e){ /* ignore if elements not present yet */ }

// ---------- Faculty Authentication ----------
const FACULTY_CREDENTIALS = {
    username: "faculty",
    password: "fac123"
};

/* --------- faculty auth (demo) --------- */
function facultyLogin() {
    const u = el('fac-user').value.trim();
    const p = el('fac-pass').value.trim();

    if (u.length === 0 || p.length === 0) {
        alert("Enter both username and password");
        return;
    }

    if (u === FACULTY_CREDENTIALS.username && p === FACULTY_CREDENTIALS.password) {
        // Login success
        hideAll();
        el('faculty-dash').classList.remove("hidden");
        showSection('mark');
    } else {
        // Wrong credentials
        alert("Incorrect username or password");
    }
}

function clearFaculty(){ el('fac-user').value=''; el('fac-pass').value=''; }
function logoutFaculty(){ sessionStorage.removeItem('facultyUser'); backHome(); }

/* --------- tabs & highlighting --------- */
function clearActiveTabs(){
  ['tab-mark','tab-view','tab-edit'].forEach(id => {
    const t = el(id); if(t) t.classList.remove('active');
  });
}
function showSection(name){
  // hide all sections
  ['mark','view','edit'].forEach(s => el('section-'+s).classList.add('hidden'));
  // clear highlight, then highlight current
  clearActiveTabs();
  const tab = el('tab-'+name); if(tab) tab.classList.add('active');
  el('section-'+name).classList.remove('hidden');
  if(name === 'mark') renderMarkTable();
  if(name === 'view') renderViewTable();
  if(name === 'edit') renderEditTable();
}

/* --------- Session/time logic --------- */
function getSessionForNow(){
  const d = new Date();
  const minutes = d.getHours()*60 + d.getMinutes();
  const amStart = 10*60, amEnd = 13*60 + 20;
  const pmStart = 14*60, pmEnd = 16*60 + 30;
  if(minutes >= amStart && minutes <= amEnd) return 'AM';
  if(minutes >= pmStart && minutes <= pmEnd) return 'PM';
  return null;
}

function todayKey(session, year){
  const d = new Date();
  const y = d.getFullYear();
  const mo = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  return `${y}-${mo}-${da}_${session}_${year}`;
}

/* --------- Academic working days --------- */
const ACADEMIC_START = new Date(2025,5,12); // June 12, 2025
function academicEndForStart(){ return new Date(ACADEMIC_START.getFullYear()+1,3,30); } // April 30 next year
function countWorkingDays(from,to){
  const d = new Date(from);
  let cnt = 0;
  while(d <= to){
    if(d.getDay() !== 0) cnt++; // exclude Sunday
    d.setDate(d.getDate()+1);
  }
  return cnt;
}
function getTotalWorkingDaysSoFar(){
  const now = new Date();
  const end = academicEndForStart();
  const upto = now < end ? now : end;
  if(upto < ACADEMIC_START) return 0;
  return countWorkingDays(ACADEMIC_START, upto);
}

/* --------- MARK attendance --------- */
function renderMarkTable(){
  const year = Number(el('mark-year').value);
  const session = getSessionForNow();
  el('session-label').innerText = session ? `Session: ${session}` : 'Outside';
  if(!session){
    el('mark-table-area').innerHTML = '<p class="note">Current time is outside marking windows. Student list is hidden.</p>';
    el('save-marks').disabled = true;
    return;
  }
  const data = loadData();
  const studs = data.students.filter(s => s.year === year);
  const key = todayKey(session, year);
  const presentList = data.attendance[key]?.present || [];
  const locked = data.attendance[key]?.locked;
  let html = '<table><thead><tr><th>SI No</th><th>PIN</th><th>Name</th><th>Present</th></tr></thead><tbody>';
  studs.forEach((s,i) => {
    const checked = presentList.includes(s.pin) ? 'checked' : '';
    const disabled = locked ? 'disabled' : '';
    html += `<tr class="${locked?'locked':''}"><td>${i+1}</td><td>${s.pin}</td><td>${s.name}</td><td><input type="checkbox" data-pin="${s.pin}" ${checked} ${disabled}></td></tr>`;
  });
  html += '</tbody></table>';
  el('mark-table-area').innerHTML = html;
  el('save-marks').disabled = !!locked;
}

function saveMarks(){
  const session = getSessionForNow();
  if(!session){ alert('Cannot save outside session times'); return; }
  const key = todayKey(session, Number(el('mark-year').value));
  const data = loadData();
  if(data.attendance[key]?.locked){ alert('Attendance already saved & locked'); return; }
  const checkboxes = document.querySelectorAll('#mark-table-area input[type="checkbox"]');
  const present = [];
  checkboxes.forEach(cb => { if(cb.checked) present.push(cb.dataset.pin); });
  data.attendance[key] = { present, locked: true };
  saveData(data); // this now saves locally and pushes to Firebase (if available)
  alert('Attendance saved & locked for ' + key);
  renderMarkTable();
}

/* --------- VIEW attendance (no "Total recorded sessions" text) --------- */
function renderViewTable(){
  const year = Number(el('view-year').value);
  const data = loadData();
  const studs = data.students.filter(s => s.year === year);
  const totalWorking = getTotalWorkingDaysSoFar();
  // show only total working days (removed total recorded sessions text)
  let html = `<p class="small muted">Total working days since 12-06-2025: ${totalWorking}</p>`;
  html += '<table><thead><tr><th>SI No</th><th>PIN</th><th>Name</th><th>Days Present</th><th>Percentage</th></tr></thead><tbody>';
  studs.forEach((s,i) => {
    let present=0;
    for(const k in data.attendance){
      if(data.attendance[k].present.includes(s.pin)) present++;
    }
    const percent = totalWorking === 0 ? 0 : Math.round((present/totalWorking)*100);
    html += `<tr><td>${i+1}</td><td>${s.pin}</td><td>${s.name}</td><td>${present}</td><td>${percent}%</td></tr>`;
  });
  html += '</tbody></table>';
  el('view-table-area').innerHTML = html;
}

/* --------- EDIT students (responsive) --------- */
function renderEditTable(){
  const data = loadData();
  let html = '';
  [1,2,3].forEach(y => {
    const studs = data.students.filter(s => s.year === y);
    html += `<h4 style="margin-top:12px">Year ${y}</h4>`;
    html += '<table><thead><tr><th>SI No</th><th>PIN</th><th>Name</th><th>Action</th></tr></thead><tbody>';
    studs.forEach((s,i) => {
      html += `<tr><td>${i+1}</td><td>${s.pin}</td><td>${s.name}</td><td><button class="btn danger" onclick="deleteStudent('${s.pin}')">Delete</button></td></tr>`;
    });
    html += '</tbody></table>';
  });
  el('edit-table-area').innerHTML = html;
}

function addStudentFromForm(){
  const pin = el('new-pin').value.trim();
  const name = el('new-name').value.trim();
  const year = Number(el('new-year').value);
  if(!pin || !name){ alert('Enter PIN and Name'); return; }
  const data = loadData();
  if(data.students.some(s=>s.pin === pin)){ alert('PIN already exists'); return; }
  data.students.push({ pin, name, year });
  saveData(data);
  el('add-student-form').reset();
  renderEditTable();
  alert('Student added: ' + pin);
}

function deleteStudent(pin){
  if(!confirm('Delete student with PIN ' + pin + '?')) return;
  const data = loadData();
  data.students = data.students.filter(s => s.pin !== pin);
  for(const k in data.attendance) data.attendance[k].present = data.attendance[k].present.filter(p => p !== pin);
  saveData(data);
  renderEditTable();
}

/* --------- STUDENT LOOKUP + weekly view --------- */
function studentLookup(){
  const pin = el('student-pin-input').value.trim();
  if(!pin){ alert('Enter PIN'); return; }
  const data = loadData();
  const s = data.students.find(x => x.pin === pin);
  if(!s){ el('student-result').innerHTML = `<p class="note">No student found with PIN ${pin}</p>`; return; }
  // count present days
  let present = 0;
  for(const k in data.attendance) if(data.attendance[k].present.includes(pin)) present++;
  const totalWorking = getTotalWorkingDaysSoFar();
  const percent = totalWorking === 0 ? 0 : Math.round((present/totalWorking)*100);
  const weekHtml = generateWeeklyTableForPin(pin);
  el('student-result').innerHTML =
    `<h3>${s.name} (Year ${s.year})</h3>` +
    `<table><tr><th class="small">Total Days Present</th><td>${present}</td></tr><tr><th class="small">Total Working Days</th><td>${totalWorking}</td></tr><tr><th class="small">Percentage</th><td>${percent}%</td></tr></table>` +
    '<div style="height:12px"></div><h4>Weekly Attendance (Mon - Sat)</h4>' + weekHtml;
}

function generateWeeklyTableForPin(pin){
  const data = loadData();
  const today = new Date();
  const day = today.getDay(); // 0 = Sunday
  const diff = (day + 6) % 7; // days since Monday
  const monday = new Date(today);
  monday.setDate(today.getDate() - diff);
  let html = '<table><thead><tr><th>Day</th><th>Date</th><th>Status</th></tr></thead><tbody>';
  const names = ['Mon','Tue','Wed','Thu','Fri','Sat'];
  for(let i=0;i<6;i++){
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    const y = d.getFullYear(), mo = String(d.getMonth()+1).padStart(2,'0'), da = String(d.getDate()).padStart(2,'0');
    const keyAM = `${y}-${mo}-${da}_AM`, keyPM = `${y}-${mo}-${da}_PM`;
    const recAM = data.attendance[keyAM] ? data.attendance[keyAM].present.includes(pin) : false;
    const recPM = data.attendance[keyPM] ? data.attendance[keyPM].present.includes(pin) : false;
    const present = recAM || recPM;
    const status = present ? `<span class="status-p">P</span>` : `<span class="status-a">A</span>`;
    html += `<tr><td>${names[i]}</td><td>${da}-${mo}-${y}</td><td>${status}</td></tr>`;
  }
  html += '</tbody></table>';
  return html;
}

/* --------- CSV export (simple) --------- */
function exportCSV(){
  const year = Number(el('view-year').value);
  const data = loadData();
  const studs = data.students.filter(s => s.year === year);
  const totalWorking = getTotalWorkingDaysSoFar();
  let csv = 'PIN,Name,DaysPresent,TotalWorkingDays,Percentage\n';
  studs.forEach(s => {
    let present = 0;
    for(const k in data.attendance) if(data.attendance[k].present.includes(s.pin)) present++;
    const percent = totalWorking === 0 ? 0 : Math.round((present/totalWorking)*100);
    csv += `${s.pin},"${s.name}",${present},${totalWorking},${percent}%\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `attendance_year${year}.csv`; a.click(); URL.revokeObjectURL(url);
}

/* --------- init UI --------- */
/* NOTE: we wait for firebase sync if available (window.firebaseSyncReady),
   otherwise proceed immediately ‚Äî this keeps behavior identical but ensures
   data from Firebase is used when present.
*/
function startAppAfterSync(){
  if(window.firebaseSyncReady && typeof window.firebaseSyncReady.then === 'function'){
    window.firebaseSyncReady.then(() => {
      // firebase sync completed
      renderEditTable();
      backHome();
    }).catch(err=>{
      console.warn('Firebase sync failed, continuing with local data', err);
      renderEditTable();
      backHome();
    });
  } else {
    renderEditTable();
    backHome();
  }
}
startAppAfterSync();

// expose debug
window._debug = { loadData, saveDataLocal };

</script>

<!-- ===== Firebase module (adds functions pushDataToFirebase and firebaseSyncReady) ===== -->
<script type="module">
  // Modular SDK imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCNGm7gErFVFS-zmd2zhnOGDBHqzK7hwUA",
    authDomain: "smart-attendance-tracker-dc3e0.firebaseapp.com",
    projectId: "smart-attendance-tracker-dc3e0",
    storageBucket: "smart-attendance-tracker-dc3e0.firebasestorage.app",
    messagingSenderId: "874135444986",
    appId: "1:874135444986:web:11676820f7fe7fc6ab5843",
    measurementId: "G-43FXHWMGZY"
    // Note: databaseURL will be used when getting database below
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  // use the provided RTDB URL
  const DATABASE_URL = "https://smart-attendance-tracker-dc3e0-default-rtdb.firebaseio.com/";
  const db = getDatabase(app, DATABASE_URL);

  // path where we store the app data
  const APP_PATH = '/appData';

  // helper: read data once from firebase and return parsed object (or null)
  async function readAppDataFromFirebase(){
    try{
      const snap = await get(ref(db, APP_PATH));
      if(snap && snap.exists()){
        return snap.val();
      }
      return null;
    } catch(e){
      console.warn('Firebase read error', e);
      return null;
    }
  }

  // helper: push data object (same shape as localStorage) to firebase
  async function pushAppDataToFirebase(obj){
    try{
      await set(ref(db, APP_PATH), obj);
      // console.log('Pushed data to Firebase');
    } catch(e){
      console.warn('Firebase write error', e);
    }
  }

  // Expose a push function to the main script (non-blocking usage)
  window.pushDataToFirebase = (data) => {
    // fire-and-forget
    pushAppDataToFirebase(data).catch(e => console.warn('push failed', e));
  };

  // Provide a promise that resolves after initial sync (so main script waits if desired)
  window.firebaseSyncReady = (async function(){
    try{
      const remote = await readAppDataFromFirebase();
      if(remote){
        // remote data exists: write to localStorage so main code can use it synchronously
        localStorage.setItem('smartStudents_final_v3', JSON.stringify(remote));
      } else {
        // no remote data: push local data to firebase so remote is populated
        const local = localStorage.getItem('smartStudents_final_v3');
        if(local){
          try{
            await pushAppDataToFirebase(JSON.parse(local));
          } catch(e){
            console.warn('initial push failed', e);
          }
        }
      }
      return true;
    } catch(err){
      console.warn('firebaseSyncReady failed', err);
      return false;
    }
  })();

</script>
</body>
</html>

