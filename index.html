<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Attendance Tracker</title>
<link rel="icon" href="Facial_Recognition-removebg.png" />

<style>
:root{
 --bg:#eef2ff;
 --card:#ffffff;
 --primary:#6366f1;
 --primary-dark:#4f46e5;
 --text:#111827;
 --muted:#6b7280;
 --danger:#ef4444;
 --success:#16a34a;
 --radius:14px;
 font-family:Inter, sans-serif;
}
body{
  background:linear-gradient(180deg,#eef2ff,#e0e7ff);
  margin:0;color:var(--text);
}
.container{
  max-width:960px;
  margin:32px auto;
  padding:16px;
}
.card{
  background:var(--card);
  padding:20px;
  border-radius:var(--radius);
  box-shadow:0 6px 20px rgba(0,0,0,.08);
}
header{display:flex;gap:12px;align-items:center;margin-bottom:22px}
.logo{width:60px;height:60px;border-radius:14px;overflow:hidden;border:2px solid #c7d2fe;display:flex;align-items:center;justify-content:center;background:#fff}
.logo img{width:100%;height:100%;object-fit:contain}
.role-btn{
  background:var(--primary);
  color:white;
  padding:14px 18px;
  min-width:140px;
  border-radius:12px;
  font-size:15px;
  font-weight:600;
}
.role-btn:hover{transform:scale(1.03);background:var(--primary-dark)}
.tab-btn{
  padding:8px 14px;
  background:#e0e7ff;
  border-radius:10px;
  margin-right:6px;
  font-size:14px;
}
.tab-btn.active{
  background:var(--primary);
  color:#fff;
  transform:translateY(-2px);
}
.btn.primary{
  background:var(--primary);
  color:white;
  padding:8px 14px;
  font-size:14px;
}
.btn.ghost{
  background:#f3f4f6;
  padding:8px 14px;
}
.btn.danger{
  background:var(--danger);
  color:white;
  padding:6px 12px;
  font-size:13px;
  border-radius:10px;
}
input,select{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-size:14px;
  width:100%;
  max-width:260px;
}
input:focus,select:focus{outline:2px solid var(--primary)}
.form-row{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.form-row > *{
  flex:1 1 auto;
  min-width:120px;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:14px;
  font-size:14px;
}
th{
  background:#eef2ff;
  padding:10px;
  text-align:left;
}
td{
  padding:8px;
  border-bottom:1px solid #e5e7eb;
}
tr:hover{background:#f5f5ff}
.status-p{color:var(--success);font-weight:700}
.status-a{color:var(--danger);font-weight:700}
.hidden{display:none}
.flex{display:flex;gap:10px;align-items:center}
.right{margin-left:auto}
@media(max-width:600px){
  .container{padding:10px;margin:10px;}
  .card{padding:16px;}
  header h1{font-size:20px;text-align:center;}
  .role-btn{width:100%;font-size:14px;}
  .tab-btn{width:100%;margin-bottom:6px;}
  input, select{width:100%;max-width:100%;}
  .flex{flex-wrap:wrap;}
  .right{margin-left:0;}
  table{font-size:13px;}
  th,td{padding:8px;}
  #mark-table-area,#view-table-area,#edit-table-area{overflow-x:auto;}
}
.small{font-size:13px;color:var(--muted)}
.note{color:var(--muted);padding:6px 0}
</style>
</head>
<body>
<div class="container">
<header>
 <div class="logo"><img src="Facial_Recognition-removebg.png" alt="logo"></div>
 <h1>Smart Attendance Tracker</h1>
</header>

<div id="home" class="card">
 <h2 style="text-align:center;margin-top:0">Welcome ‚Äî Choose Role</h2>
 <p style="text-align:center;color:var(--muted);margin-top:-4px">Use Student for personal view. Faculty will mark and manage attendance.</p>
 <div style="display:flex;gap:20px;justify-content:center;margin-top:20px;flex-wrap:wrap">
   <button id="btn-student" class="role-btn" onclick="openStudent()">Student</button>
   <button id="btn-faculty" class="role-btn" onclick="openFaculty()">Faculty</button>
 </div>
</div>

<div id="faculty-login" class="card hidden">
 <div class="flex">
   <strong>Faculty Login</strong>
   <button class="btn ghost right" onclick="backHome()">‚¨Ö Back</button>
 </div>
 <div style="margin-top:12px">
   <label>Username</label>
   <input id="fac-user" placeholder="Enter username" />
 </div>
 <div style="margin-top:10px">
   <label>Password</label>
   <input id="fac-pass" type="password" placeholder="Enter password" />
 </div>
 <div class="flex" style="margin-top:14px">
   <button class="btn primary" onclick="facultyLogin()">Login</button>
   <button class="btn ghost" onclick="clearFaculty()">Clear</button>
 </div>
</div>

<div id="faculty-dash" class="card hidden">
 <div class="flex" style="justify-content:space-between">
   <strong>Faculty Dashboard</strong>
   <button class="btn ghost" onclick="logoutFaculty()">Logout</button>
 </div>

 <div style="margin-top:14px">
   <button id="tab-mark" class="tab-btn" onclick="showSection('mark')">üìù Mark Attendance</button>
   <button id="tab-view" class="tab-btn" onclick="showSection('view')">üìä View Attendance</button>
   <button id="tab-edit" class="tab-btn" onclick="showSection('edit')">üë• Edit Students</button>
 </div>

 <div id="section-mark" class="hidden" style="margin-top:18px">
   <div class="flex" style="align-items:center">
     <label>Choose Year:</label>
     <select id="mark-year" onchange="renderMarkTable()"><option value="1">1st</option><option value="2">2nd</option><option value="3">3rd</option></select>
     <span id="session-label" class="small" style="margin-left:8px"></span>
     <button id="save-marks" class="btn primary right" onclick="saveMarks()">Save</button>
   </div>
   <div id="mark-table-area"></div>
 </div>

<div id="section-view" class="hidden" style="margin-top:18px">
   <div class="flex">
      <label>Choose Year:</label>
      <select id="view-year" onchange="renderViewTable()">
         <option value="1">1st</option>
         <option value="2">2nd</option>
         <option value="3">3rd</option>
      </select>
      <button class="btn primary right" onclick="exportCSV()">Download CSV</button>
   </div>
   <div id="view-table-area" style="margin-top:10px"></div>
</div>

 <div id="section-edit" class="hidden" style="margin-top:18px">
   <form id="add-student-form" onsubmit="event.preventDefault(); addStudentFromForm()">
     <div class="form-row" style="margin-top:8px">
       <input id="new-pin" type="text" class="pin-input" placeholder="PIN (e.g. 25183-CM-001)" required />
       <input id="new-name" type="text" placeholder="Student name" required />
       <select id="new-year"><option value="1">1st</option><option value="2">2nd</option><option value="3">3rd</option></select>
       <button class="btn primary" type="submit">Add</button>
     </div>
   </form>
   <div id="edit-table-area" style="margin-top:12px"></div>
 </div>
</div>

<div id="student-screen" class="card hidden" style="margin-top:16px">
 <div class="flex"><strong>Enter PIN</strong><button class="btn ghost right" onclick="backHome()">Back</button></div>
 <div class="flex" style="margin-top:14px">
   <input id="student-pin-input" placeholder="25183-CM-001" />
   <button class="btn primary" onclick="studentLookup()">Go</button>
 </div>
 <div id="student-result" style="margin-top:14px"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCNGm7gErFVFS-zmd2zhnOGDBHqzK7hwUA",
  authDomain: "smart-attendance-tracker-dc3e0.firebaseapp.com",
  projectId: "smart-attendance-tracker-dc3e0",
  storageBucket: "smart-attendance-tracker-dc3e0.firebasestorage.app",
  messagingSenderId: "874135444986",
  appId: "1:874135444986:web:11676820f7fe7fc6ab5843",
  measurementId: "G-43FXHWMGZY",
  databaseURL: "https://smart-attendance-tracker-dc3e0-default-rtdb.firebaseio.com/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const APP_PATH = '/appData';
let appState = { students: [], attendance: {} };

const FACULTY_CREDENTIALS = { username: "faculty", password: "fac123" };

async function readRemoteData() {
  try {
    const snap = await get(ref(db, APP_PATH));
    if (snap && snap.exists()) return snap.val();
    return null;
  } catch (e) {
    console.warn('Firebase read error', e);
    return null;
  }
}
async function writeRemoteData(obj){
  try {
    await set(ref(db, APP_PATH), obj);
    return true;
  } catch(e){
    console.warn('Firebase write error', e);
    return false;
  }
}

function el(id){ return document.getElementById(id); }

function yearPrefixFor(year){
  const currentTwo = new Date().getFullYear() % 100;
  if(year === 1) return currentTwo;
  if(year === 2) return currentTwo - 1;
  return currentTwo - 2;
}

function seedExample(){
  const p1 = `${String(yearPrefixFor(1)).padStart(2,'0')}183-CM-001`;
  const p2 = `${String(yearPrefixFor(1)).padStart(2,'0')}183-CM-002`;
  const p3 = `${String(yearPrefixFor(2)).padStart(2,'0')}183-CM-001`;
  const p4 = `${String(yearPrefixFor(2)).padStart(2,'0')}183-CM-002`;
  const p5 = `${String(yearPrefixFor(3)).padStart(2,'0')}183-CM-001`;
  return {
    students: [
      { pin: p1, name: 'Ravi Kumar', year: 1 },
      { pin: p2, name: 'Sita Reddy', year: 1 },
      { pin: p3, name: 'Anil Shah', year: 2 },
      { pin: p4, name: 'Geeta Devi', year: 2 },
      { pin: p5, name: 'Mohan Das', year: 3 }
    ],
    attendance: {}
  };
}

function hideAll(){ document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden')); }
function backHome(){ hideAll(); el('home').classList.remove('hidden'); clearActiveTabs(); }
function openStudent(){ hideAll(); el('student-screen').classList.remove('hidden'); }
function openFaculty(){ hideAll(); el('faculty-login').classList.remove('hidden'); }

function clearActiveTabs(){ ['tab-mark','tab-view','tab-edit'].forEach(id => { const t = el(id); if(t) t.classList.remove('active'); }); }
function showSection(name){
  ['mark','view','edit'].forEach(s => el('section-'+s).classList.add('hidden'));
  clearActiveTabs();
  const tab = el('tab-'+name); if(tab) tab.classList.add('active');
  el('section-'+name).classList.remove('hidden');
  if(name === 'mark') renderMarkTable();
  if(name === 'view') renderViewTable();
  if(name === 'edit') renderEditTable();
}

function getSessionForNow(){
  const d = new Date();
  const minutes = d.getHours()*60 + d.getMinutes();
  const amStart = 10*60, amEnd = 13*60 + 20;
  const pmStart = 14*60, pmEnd = 16*60 + 30;
  if(minutes >= amStart && minutes <= amEnd) return 'AM';
  if(minutes >= pmStart && minutes <= pmEnd) return 'PM';
  return null;
}
function todayKey(session, year){
  const d = new Date();
  const y = d.getFullYear();
  const mo = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  return `${y}-${mo}-${da}_${session}_${year}`;
}

const ACADEMIC_START = new Date(2025,5,12);
function academicEndForStart(){ return new Date(ACADEMIC_START.getFullYear()+1,3,30); }
function countWorkingDays(from,to){
  const d = new Date(from);
  let cnt = 0;
  while(d <= to){
    if(d.getDay() !== 0) cnt++;
    d.setDate(d.getDate()+1);
  }
  return cnt;
}
function getTotalWorkingDaysSoFar(){
  const now = new Date();
  const end = academicEndForStart();
  const upto = now < end ? now : end;
  if(upto < ACADEMIC_START) return 0;
  return countWorkingDays(ACADEMIC_START, upto);
}

function getData(){ return appState; }

async function saveData(state){
  appState = state;
  await writeRemoteData(appState);
}

function renderMarkTable(){
  const year = Number(el('mark-year').value);
  const session = getSessionForNow();
  el('session-label').innerText = session ? `Session: ${session}` : 'Outside';
  if(!session){
    el('mark-table-area').innerHTML = '<p class="note">Current time is outside marking windows. Student list is hidden.</p>';
    el('save-marks').disabled = true;
    return;
  }
  const data = getData();
  const studs = data.students.filter(s => s.year === year);
  const key = todayKey(session, year);
  const presentList = data.attendance[key]?.present || [];
  const locked = data.attendance[key]?.locked;
  let html = '<table><thead><tr><th>SI No</th><th>PIN</th><th>Name</th><th>Present</th></tr></thead><tbody>';
  studs.forEach((s,i)=>{
    const checked = presentList.includes(s.pin) ? 'checked' : '';
    const disabled = locked ? 'disabled' : '';
    html += `<tr><td>${i+1}</td><td>${s.pin}</td><td>${s.name}</td><td><input type="checkbox" data-pin="${s.pin}" ${checked} ${disabled}></td></tr>`;
  });
  html += '</tbody></table>';
  el('mark-table-area').innerHTML = html;
  el('save-marks').disabled = !!locked;
}

async function saveMarks(){
  const session = getSessionForNow();
  if(!session){ alert('Cannot save outside session times'); return; }
  const year = Number(el('mark-year').value);
  const key = todayKey(session, year);
  const data = getData();
  if(data.attendance[key]?.locked){ alert('Attendance already saved & locked'); return; }
  const checkboxes = document.querySelectorAll('#mark-table-area input[type="checkbox"]');
  const present = [];
  checkboxes.forEach(cb => { if(cb.checked) present.push(cb.dataset.pin); });
  data.attendance[key] = { present, locked: true };
  await saveData(data);
  alert('Attendance saved & locked for ' + key);
  renderMarkTable();
}

function renderViewTable(){
  const year = Number(el('view-year').value);
  const data = getData();
  const studs = data.students.filter(s => s.year === year);
  const totalWorking = getTotalWorkingDaysSoFar();
  let html = `<p class="small muted">Total working days since 12-06-2025: ${totalWorking}</p>`;
  html += '<table><thead><tr><th>SI No</th><th>PIN</th><th>Name</th><th>Days Present</th><th>Percentage</th></tr></thead><tbody>';
  studs.forEach((s,i)=>{
    let present = 0;
    for(const k in data.attendance){
      if(data.attendance[k].present.includes(s.pin)) present++;
    }
    const percent = totalWorking === 0 ? 0 : Math.round((present/totalWorking)*100);
    html += `<tr><td>${i+1}</td><td>${s.pin}</td><td>${s.name}</td><td>${present}</td><td>${percent}%</td></tr>`;
  });
  html += '</tbody></table>';
  el('view-table-area').innerHTML = html;
}

function renderEditTable(){
  const data = getData();
  let html = '';
  [1,2,3].forEach(y=>{
    const studs = data.students.filter(s=>s.year===y);
    html += `<h4 style="margin-top:12px">Year ${y}</h4>`;
    html += '<table><thead><tr><th>SI No</th><th>PIN</th><th>Name</th><th>Action</th></tr></thead><tbody>';
    studs.forEach((s,i)=>{
      html += `<tr><td>${i+1}</td><td>${s.pin}</td><td>${s.name}</td><td><button class="btn danger" onclick="deleteStudent('${s.pin}')">Delete</button></td></tr>`;
    });
    html += '</tbody></table><div style="height:12px"></div>';
  });
  el('edit-table-area').innerHTML = html;
}

async function addStudentFromForm(){
  const pin = el('new-pin').value.trim();
  const name = el('new-name').value.trim();
  const year = Number(el('new-year').value);
  if(!pin || !name){ alert('Enter PIN and Name'); return; }
  const data = getData();
  if(data.students.some(s=>s.pin === pin)){ alert('PIN already exists'); return; }
  data.students.push({ pin, name, year });
  await saveData(data);
  el('add-student-form').reset();
  renderEditTable();
  alert('Student added: ' + pin);
}

async function deleteStudent(pin){
  if(!confirm('Delete student with PIN ' + pin + '?')) return;
  const data = getData();
  data.students = data.students.filter(s => s.pin !== pin);
  for(const k in data.attendance) data.attendance[k].present = data.attendance[k].present.filter(p => p !== pin);
  await saveData(data);
  renderEditTable();
}

function generateWeeklyTableForPin(pin){
  const data = getData();
  const today = new Date();
  const day = today.getDay();
  const diff = (day + 6) % 7;
  const monday = new Date(today);
  monday.setDate(today.getDate() - diff);
  let html = '<table><thead><tr><th>Day</th><th>Date</th><th>Status</th></tr></thead><tbody>';
  const names = ['Mon','Tue','Wed','Thu','Fri','Sat'];
  for(let i=0;i<6;i++){
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    const y = d.getFullYear(), mo = String(d.getMonth()+1).padStart(2,'0'), da = String(d.getDate()).padStart(2,'0');
    const keyAM = `${y}-${mo}-${da}_AM_1`, keyPM = `${y}-${mo}-${da}_PM_1`;
    const recAM = data.attendance[keyAM] ? data.attendance[keyAM].present.includes(pin) : false;
    const recPM = data.attendance[keyPM] ? data.attendance[keyPM].present.includes(pin) : false;
    const present = recAM || recPM;
    const status = present ? `<span class="status-p">P</span>` : `<span class="status-a">A</span>`;
    html += `<tr><td>${names[i]}</td><td>${da}-${mo}-${y}</td><td>${status}</td></tr>`;
  }
  html += '</tbody></table>';
  return html;
}

function studentLookup(){
  const pin = el('student-pin-input').value.trim();
  if(!pin){ alert('Enter PIN'); return; }
  const data = getData();
  const s = data.students.find(x => x.pin === pin);
  if(!s){ el('student-result').innerHTML = `<p class="note">No student found with PIN ${pin}</p>`; return; }
  let present = 0;
  for(const k in data.attendance) if(data.attendance[k].present.includes(pin)) present++;
  const totalWorking = getTotalWorkingDaysSoFar();
  const percent = totalWorking === 0 ? 0 : Math.round((present/totalWorking)*100);
  const weekHtml = generateWeeklyTableForPin(pin);
  el('student-result').innerHTML =
    `<h3>${s.name} (Year ${s.year})</h3>` +
    `<table><tr><th class="small">Total Days Present</th><td>${present}</td></tr><tr><th class="small">Total Working Days</th><td>${totalWorking}</td></tr><tr><th class="small">Percentage</th><td>${percent}%</td></tr></table>` +
    '<div style="height:12px"></div><h4>Weekly Attendance (Mon - Sat)</h4>' + weekHtml;
}

function exportCSV(){
  const year = Number(el('view-year').value);
  const data = getData();
  const studs = data.students.filter(s=>s.year===year);
  const totalWorking = getTotalWorkingDaysSoFar();
  let csv = 'PIN,Name,DaysPresent,TotalWorkingDays,Percentage\n';
  studs.forEach(s=>{
    let present = 0;
    for(const k in data.attendance) if(data.attendance[k].present.includes(s.pin)) present++;
    const percent = totalWorking === 0 ? 0 : Math.round((present/totalWorking)*100);
    csv += `${s.pin},"${s.name}",${present},${totalWorking},${percent}%\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `attendance_year${year}.csv`; a.click(); URL.revokeObjectURL(url);
}

function facultyLogin(){
  const u = el('fac-user').value.trim();
  const p = el('fac-pass').value.trim();
  if(u.length===0 || p.length===0){ alert('Enter both username and password'); return; }
  if(u === FACULTY_CREDENTIALS.username && p === FACULTY_CREDENTIALS.password){
    sessionStorage.setItem('facultyUser', u);
    hideAll();
    el('faculty-dash').classList.remove('hidden');
    showSection('mark');
  } else {
    alert('Incorrect username or password');
  }
}
function clearFaculty(){ el('fac-user').value=''; el('fac-pass').value=''; }
function logoutFaculty(){ sessionStorage.removeItem('facultyUser'); backHome(); }

async function bootstrap(){
  const remote = await readRemoteData();
  if(remote){
    appState = remote;
    if(!appState.students) appState.students = [];
    if(!appState.attendance) appState.attendance = {};
  } else {
    appState = seedExample();
    await writeRemoteData(appState);
  }
  renderEditTable();
  backHome();
}
bootstrap();

window.saveData = saveData;
window.getData = getData;
window.exportCSV = exportCSV;
window.addStudentFromForm = addStudentFromForm;
window.deleteStudent = deleteStudent;
window.renderViewTable = renderViewTable;
window.renderMarkTable = renderMarkTable;
window.renderEditTable = renderEditTable;
window.saveMarks = saveMarks;
window.studentLookup = studentLookup;
window.showSection = showSection;
window.openStudent = openStudent;
window.openFaculty = openFaculty;
window.backHome = backHome;
window.facultyLogin = facultyLogin;
window.clearFaculty = clearFaculty;
window.logoutFaculty = logoutFaculty;

</script>
</body>
</html>
