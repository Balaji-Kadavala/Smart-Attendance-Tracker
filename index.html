<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Attendance Tracker</title>
<link rel="icon" href="Facial_Recognition-removebg.png" />

<style>
:root{
 --bg:#eef2ff;
 --card:#ffffff;
 --primary:#6366f1;
 --primary-dark:#4f46e5;
 --text:#111827;
 --muted:#6b7280;
 --danger:#ef4444;
 --success:#16a34a;
 --radius:14px;
 font-family:Inter, sans-serif;
}
body{ background:linear-gradient(180deg,#eef2ff,#e0e7ff); margin:0;color:var(--text); }
.container{ max-width:960px; margin:32px auto; padding:16px; }
.card{ background:var(--card); padding:20px; border-radius:var(--radius); box-shadow:0 6px 20px rgba(0,0,0,.08); }
header{display:flex;gap:12px;align-items:center;margin-bottom:22px}
.logo{width:60px;height:60px;border-radius:14px;overflow:hidden;border:2px solid #c7d2fe;display:flex;align-items:center;justify-content:center;background:#fff}
.logo img{width:100%;height:100%;object-fit:contain}
.role-btn{ background:var(--primary); color:white; padding:14px 18px; min-width:140px; border-radius:12px; font-size:15px; font-weight:600; }
.role-btn:hover{transform:scale(1.03);background:var(--primary-dark)}
.tab-btn{ padding:8px 14px; background:#e0e7ff; border-radius:10px; margin-right:6px; font-size:14px; }
.tab-btn.active{ background:var(--primary); color:#fff; transform:translateY(-2px); }
.btn.primary{ background:var(--primary); color:white; padding:8px 14px; font-size:14px; }
.btn.ghost{ background:#f3f4f6; padding:8px 14px; }
.btn.danger { background: var(--danger); color: white; padding: 8px 14px; font-size: 14px; border-radius: 12px; font-weight: 600; transition: transform 0.15s ease; }
.btn.danger:hover { transform: scale(1.03); background: #dc2626; }
input,select{ padding:8px 10px; border-radius:10px; border:1px solid #d1d5db; font-size:14px; width:100%; max-width:260px; }
input:focus,select:focus{outline:2px solid var(--primary)}
.form-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.form-row > *{ flex:1 1 auto; min-width:120px; }
table{ width:100%; border-collapse:collapse; margin-top:14px; font-size:14px; }
th{ background:#eef2ff; padding:10px; text-align:left; }
td{ padding:8px; border-bottom:1px solid #e5e7eb; }
tr:hover{background:#f5f5ff}
.status-p{color:var(--success);font-weight:700}
.status-a{color:var(--danger);font-weight:700}
.hidden{display:none}
.flex{display:flex;gap:10px;align-items:center}
.right{margin-left:auto}
@media(max-width:600px){
  .container{ padding:10px; margin:10px; }
  .card{ padding:16px; }
  header h1{ font-size:20px; text-align:center; }
  .role-btn{ width:100%; font-size:14px; }
  .tab-btn{ width:100%; margin-bottom:6px; }
  input, select{ width:100%; max-width:100%; }
  .flex{ flex-wrap:wrap; }
  .right{ margin-left:0; }
  table{ font-size:13px; }
  th,td{ padding:8px; }
  #mark-table-area, #view-table-area, #edit-table-area{ overflow-x:auto; }
}
</style>
</head>
<body>
<div class="container">
<header>
 <div class="logo"><img src="Facial_Recognition-removebg.png" alt="logo"></div>
 <h1>Smart Attendance Tracker</h1>
</header>

<!-- Tagline placed just below the title -->
<p id="tagline"
   style="margin: -10px 0 20px 90px; 
          color: var(--muted); 
          font-size: 15px;">
   A Unified Platform for Secure and Transparent Attendance Management.
</p>

<!-- HOME -->
<div id="home" class="card">
  <h2 style="text-align:center;margin-top:0;font-size:26px;font-weight:700;">
    Select Access Category
  </h2>

  <p style="text-align:center;color:var(--muted);margin-top:8px;font-size:14.5px;">
    Please choose your role to continue.
  </p>

  <div style="display:flex;gap:20px;justify-content:center;margin-top:22px;flex-wrap:wrap">
    <button id="btn-student" class="role-btn" onclick="openStudent()">Student</button>
    <button id="btn-faculty" class="role-btn" onclick="openFaculty()">Faculty</button>
  </div>
</div>

<!-- FACULTY LOGIN -->
<div id="faculty-login" class="card hidden">
 <div class="flex">
   <strong>Faculty Login</strong>
   <button class="btn ghost right" onclick="backHome()">‚¨Ö Back</button>
 </div>
 <div style="margin-top:12px">
   <label>Username</label>
   <input id="fac-user" placeholder="Enter username" />
 </div>
 <div style="margin-top:10px">
   <label>Password</label>
   <input id="fac-pass" type="password" placeholder="Enter password" />
 </div>
 <div class="flex" style="margin-top:14px">
   <button class="btn primary" onclick="facultyLogin()">Login</button>
   <button class="btn ghost" onclick="clearFaculty()">Clear</button>
 </div>
</div>

<!-- FACULTY DASHBOARD -->
<div id="faculty-dash" class="card hidden">
 <div class="flex" style="justify-content:space-between">
   <strong>Faculty Dashboard</strong>
   <button class="btn ghost" onclick="logoutFaculty()">Logout</button>
 </div>

 <div style="margin-top:14px">
   <button id="tab-mark" class="tab-btn" onclick="showSection('mark')">üìù Mark Attendance</button>
   <button id="tab-view" class="tab-btn" onclick="showSection('view')">üìä View Attendance</button>
   <button id="tab-edit" class="tab-btn" onclick="showSection('edit')">üë• Edit Students</button>
 </div>

 <!-- MARK -->
 <div id="section-mark" class="hidden" style="margin-top:18px">
   <div class="flex" style="align-items:center">
     <label>Choose Year:</label>
     <select id="mark-year" onchange="renderMarkTable()"><option value="1">1st</option><option value="2">2nd</option><option value="3">3rd</option></select>
     <span id="session-label" class="small" style="margin-left:8px"></span>
     <!-- Save left -->
     <button id="save-marks" class="btn primary" onclick="saveMarks()">Save</button>
     <!-- Holiday right -->
     <button id="holiday-btn" class="btn danger right" onclick="markHoliday()">Mark Holiday</button>
   </div>
   <div id="mark-table-area"></div>
 </div>

 <!-- VIEW -->
<div id="section-view" class="hidden" style="margin-top:18px">
   <div class="flex">
      <label>Choose Year:</label>
      <select id="view-year" onchange="renderViewTable()">
         <option value="1">1st</option>
         <option value="2">2nd</option>
         <option value="3">3rd</option>
      </select>

      <!-- CSV EXPORT -->
      <button class="btn primary right" onclick="exportCSV()">Download CSV</button>
   </div>

   <div id="view-table-area" style="margin-top:10px"></div>
</div>

 <!-- EDIT -->
 <div id="section-edit" class="hidden" style="margin-top:18px">
   <form id="add-student-form" onsubmit="event.preventDefault(); addStudentFromForm()">
     <div class="form-row" style="margin-top:8px">
       <input id="new-pin" type="text" class="pin-input" placeholder="PIN (e.g. 25183-CM-001)" required />
       <input id="new-name" type="text" placeholder="Student name" required />
       <select id="new-year"><option value="1">1st</option><option value="2">2nd</option><option value="3">3rd</option></select>
       <button class="btn primary" type="submit">Add</button>
     </div>
   </form>
   <div id="edit-table-area" style="margin-top:12px"></div>
 </div>
</div>

<!-- STUDENT -->
<div id="student-screen" class="card hidden" style="margin-top:16px">
 <div class="flex"><strong>Enter PIN</strong><button class="btn ghost right" onclick="backHome()">Back</button></div>
 <div class="flex" style="margin-top:14px">
   <input id="student-pin-input" placeholder="PIN (e.g 25183-CM-001)" />
   <button class="btn primary" onclick="studentLookup()">Go</button>
 </div>
 <div id="student-result" style="margin-top:14px"></div>
</div>

</div>

<footer style="
  text-align:center;
  margin-top:40px;
  padding:18px;
  font-size:14px;
  color:#6b7280;
">
  ¬© 2025 Smart Attendance Tracker ‚Äî Designed for Secure & Efficient Academic Management.
</footer>


<!-- FIREBASE + APP JAVASCRIPT -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, set, push, get, child, update, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCNGm7gErFVFS-zmd2zhnOGDBHqzK7hwUA",
    authDomain: "smart-attendance-tracker-dc3e0.firebaseapp.com",
    projectId: "smart-attendance-tracker-dc3e0",
    storageBucket: "smart-attendance-tracker-dc3e0.firebasestorage.app",
    messagingSenderId: "874135444986",
    appId: "1:874135444986:web:11676820f7fe7fc6ab5843",
    measurementId: "G-43FXHWMGZY",
    databaseURL: "https://smart-attendance-tracker-dc3e0-default-rtdb.firebaseio.com/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ---------- Helpers ----------
  async function fetchStudentsMap(){
    const snap = await get(child(ref(db), 'students'));
    return snap.exists() ? snap.val() : {};
  }

  async function fetchAttendance(){
    const snap = await get(child(ref(db), 'attendance'));
    return snap.exists() ? snap.val() : {};
  }

  function dateKeyOnly() {
    const d = new Date();
    const y = d.getFullYear();
    const mo = String(d.getMonth() + 1).padStart(2, '0');
    const da = String(d.getDate()).padStart(2, '0');
    return `${y}-${mo}-${da}`;
  }

  function hideAll(){document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden')); }
  function backHome(){ hideAll(); document.getElementById('home').classList.remove('hidden'); }
  function openFaculty(){ hideAll(); document.getElementById('faculty-login').classList.remove('hidden'); }
  function openStudent(){ hideAll(); document.getElementById('student-screen').classList.remove('hidden'); }

  document.getElementById('btn-student').style.background = getComputedStyle(document.documentElement).getPropertyValue('--primary');
  document.getElementById('btn-student').style.color = '#fff';
  document.getElementById('btn-faculty').style.background = getComputedStyle(document.documentElement).getPropertyValue('--primary');
  document.getElementById('btn-faculty').style.color = '#fff';

  function facultyLogin(){
    const u = document.getElementById('fac-user').value.trim();
    const p = document.getElementById('fac-pass').value.trim();
    if(u.length===0 || p.length===0){ alert('Enter both username and password'); return; }
    sessionStorage.setItem('facultyUser', u);
    hideAll(); document.getElementById('faculty-dash').classList.remove('hidden');
    showSection('mark');
  }
  function clearFaculty(){ document.getElementById('fac-user').value=''; document.getElementById('fac-pass').value=''; }
  function logoutFaculty(){ sessionStorage.removeItem('facultyUser'); backHome(); }

  function showSection(name) {
    ['mark', 'view', 'edit'].forEach(s => document.getElementById('section-' + s).classList.add('hidden'));
    ['tab-mark', 'tab-view', 'tab-edit'].forEach(id => document.getElementById(id).classList.remove('active'));
    document.getElementById('section-' + name).classList.remove('hidden');
    document.getElementById('tab-' + name).classList.add('active');
    if (name === 'mark') renderMarkTable();
    if (name === 'view') renderViewTable();
    if (name === 'edit') renderEditTable();
  }

  // Session/time logic
  function getSessionForNow(){
    const d=new Date(); const h=d.getHours(); const m=d.getMinutes();
    const minutes = h*60 + m;
    const amStart = 10*60; const amEnd = 13*60 + 20;
    const pmStart = 14*60; const pmEnd = 16*60 + 30;
    if(minutes>=amStart && minutes<=amEnd) return 'AM';
    if(minutes>=pmStart && minutes<=pmEnd) return 'PM';
    return null;
  }
  function todayKey(session){ const d=new Date(); const y=d.getFullYear(); const mo=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${mo}-${da}_${session}`; }

  // Academic working days
  const ACADEMIC_START = new Date(2025,5,12); // June 12, 2025
  function academicEndForStart(){ const end = new Date(ACADEMIC_START.getFullYear()+1,3,30); return end; }

  async function getTotalWorkingDaysSoFar(year){
    const now=new Date();
    const end = academicEndForStart();
    const upto = now<end ? now : end;
    if(upto<ACADEMIC_START) return 0;

    const attendance = await fetchAttendance();
    let count=0;
    const d = new Date(ACADEMIC_START);
    while(d<=upto){
      if(d.getDay()!==0){
        const y=d.getFullYear(), mo=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
        const keyAM = `${y}-${mo}-${da}_AM`;
        const keyPM = `${y}-${mo}-${da}_PM`;

        const isHolidayForYear = (attendance[keyAM] && attendance[keyAM][year] && attendance[keyAM][year].holiday)
                               || (attendance[keyPM] && attendance[keyPM][year] && attendance[keyPM][year].holiday)
                               || (attendance[`${y}-${mo}-${da}`] && attendance[`${y}-${mo}-${da}`][year] && attendance[`${y}-${mo}-${da}`][year].fullDayHoliday);

        if(!isHolidayForYear) count++;
      }
      d.setDate(d.getDate()+1);
    }
    return count;
  }

  // ---------- Render Mark Table ----------
  async function renderMarkTable(){
    const year=Number(document.getElementById('mark-year').value);
    const session = getSessionForNow();
    const sessionLabel = session || 'None';
    document.getElementById('session-label').innerText = `Session: ${sessionLabel}`;

    // If outside session, show message but still allow viewing holiday state
    if (!session) {
      document.getElementById('mark-table-area').innerHTML =
        '<p class="note">Current time is outside marking windows. Student list is hidden until session opens.</p>';
      document.getElementById('save-marks').style.display = "none";
      document.getElementById('holiday-btn').style.display = "none";
      return;
    } else {
      document.getElementById('save-marks').style.display = "inline-block";
      document.getElementById('holiday-btn').style.display = "inline-block";
    }

    // Load students & attendance
    const students = await fetchStudentsMap();
    const studs = Object.entries(students)
      .filter(([pin,s]) => Number(s.year) === year)
      .map(([pin,s]) => ({ pin, name: s.name, year: s.year }));

    const attendance = await fetchAttendance();

    // Keys
    const keyAM = todayKey("AM");
    const keyPM = todayKey("PM");
    const dateKey = dateKeyOnly();

    // Session records
    const recAM = attendance[keyAM] || {};
    const recPM = attendance[keyPM] || {};

    const yearRecAM = recAM[year] || {};
    const yearRecPM = recPM[year] || {};

    const fullDayRec = attendance[dateKey]?.[year] || {};

    // TRUE holiday if either:
    // 1) session-level holiday present
    // 2) full-day holiday flag set in dateKey
    let isHoliday = !!(
        yearRecAM.holiday ||
        yearRecPM.holiday ||
        fullDayRec.fullDayHoliday
    );

    // ---------------- AUTO-HOLIDAY RULE ----------------
    const now = new Date();
    const amEndMins = (13 * 60) + 20;
    const currentMins = now.getHours() * 60 + now.getMinutes();

    // Auto-holiday triggers ONLY if AM not saved (locked) and AM session window is over
    const lockedAM = !!yearRecAM.locked;
    const lockedPM = !!yearRecPM.locked;

    if (currentMins > amEndMins && !lockedAM && !fullDayRec.fullDayHoliday) {
        const updates = {};
        updates[`attendance/${dateKey}/${year}`] = { fullDayHoliday: true };
        updates[`attendance/${keyAM}/${year}`] = { holiday: true, locked: true };
        updates[`attendance/${keyPM}/${year}`] = { holiday: true, locked: true };

        await update(ref(db), updates);

        // reflect locally (so UI responds immediately)
        isHoliday = true;
    }

// LOCK ONLY current session
const locked = (session === "AM" ? lockedAM : lockedPM);


    // If holiday ‚Üí disable table completely
    if (isHoliday) {
        document.getElementById('mark-table-area').innerHTML =
            '<p class="note" style="color:#dc2626;font-weight:bold">Holiday ‚Äî Attendance cannot be taken.</p>';
        // hide buttons too
        document.getElementById('save-marks').style.display = "none";
        document.getElementById('holiday-btn').style.display = "none";
        return;
    }

    // Build table
    let html = '';
    html += '<table><thead><tr><th>SI No</th><th>PIN</th><th>Name</th><th>Present</th></tr></thead><tbody>';
    studs.forEach((s,idx)=>{
      const presentMap = (session === 'AM' ? (yearRecAM.present||{}) : (yearRecPM.present||{}));
      const checked = presentMap && presentMap[s.pin] ? 'checked' : '';
      const disabled = (locked) ? 'disabled' : '';
      html += `<tr class="hover-scale ${(locked)? 'locked':''}"><td>${idx+1}</td><td>${s.pin}</td><td>${s.name}</td><td><input class="student-checkbox year-${year}" data-pin="${s.pin}" type="checkbox" ${checked} ${disabled}></td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('mark-table-area').innerHTML = html;

    // UI button logic
    const saveBtn = document.getElementById('save-marks');
    const holidayBtn = document.getElementById('holiday-btn');

    // Determine if current session is already locked
    const currentSessionLocked = session === 'AM' ? lockedAM : lockedPM;

    // If full-day holiday -> already returned above.
    // If AM saved for this year (lockedAM) => hide holiday button for whole day (as required)
    // If current session already locked => hide save button for that session
    if (isHoliday) {
      saveBtn.style.display = "none";
      holidayBtn.style.display = "none";
    } else {
      // save button visible only if current session not locked
      saveBtn.style.display = currentSessionLocked ? "none" : "inline-block";

      // holiday button hidden if AM is saved (lockedAM) else visible
      holidayBtn.style.display = lockedAM ? "none" : "inline-block";
    }
  }

  // ---------- Save Marks ----------
  async function saveMarks(){
    const session = getSessionForNow();
    if(!session){ alert('Cannot save outside session times'); return; }

    const key = todayKey(session);
    const year = Number(document.getElementById('mark-year').value);

    const attendance = await fetchAttendance();
    const sessionRec = attendance && attendance[key] ? attendance[key] : {};
    const yearRec = sessionRec[year] || {};
    if (yearRec.locked || yearRec.holiday) {
      alert('Attendance for this year is already saved/locked or holiday for this session.');
      return;
    }

    // collect checkboxes
    const checkboxes = document.querySelectorAll('#mark-table-area input[type="checkbox"]');
    const presentObj = {};
    checkboxes.forEach(cb => { if(cb.checked) presentObj[cb.dataset.pin] = true; });

    // Save updates
    const updates = {};
    const baseKey = dateKeyOnly();
    if (session === "AM") {
        // mark that AM was saved for this date/year; also ensure fullDayHoliday flag is explicitly false so auto rule won't trigger later
        updates[`attendance/${baseKey}/${year}`] = { fullDayHoliday: false, amSaved: true };
    }
    updates[`attendance/${key}/${year}`] = {
      locked: true,
      present: presentObj
    };

    await update(ref(db), updates);

    alert('Attendance saved and locked for ' + key + ' (Year ' + year + ')');
    await renderMarkTable();
  }

  // ---------- Mark Holiday (FULL DAY) ----------
  async function markHoliday() {
    const year = Number(document.getElementById('mark-year').value);

    if (!confirm(`Mark FULL DAY HOLIDAY for Year ${year}?`)) return;

    const today = dateKeyOnly();
    const keyAM = todayKey("AM");
    const keyPM = todayKey("PM");

    const updates = {};
    updates[`attendance/${today}/${year}`] = { fullDayHoliday: true };
    updates[`attendance/${keyAM}/${year}`] = { holiday: true, locked: true };
    updates[`attendance/${keyPM}/${year}`] = { holiday: true, locked: true };

    await update(ref(db), updates);

    alert("Holiday marked and stored correctly!");
    await renderMarkTable();
  }

  // ---------- View / Edit / Student functions ----------
  async function getTotalSessionsForYear(year){
    const students = await fetchStudentsMap();
    const yearPins = new Set(Object.entries(students).filter(([pin,s]) => Number(s.year)===year).map(([pin]) => pin));
    const attendance = await fetchAttendance();
    let count = 0;
    for(const k in attendance){
      const rec = attendance[k];
      if(!rec) continue;
      const yrs = Object.keys(rec);
      for(const yr of yrs){
        const yrRec = rec[yr];
        if(yrRec.present){
          const presentPins = Object.keys(yrRec.present);
          if(presentPins.some(p => yearPins.has(p))){
            count++;
            break;
          }
        }
      }
    }
    return count;
  }

  async function renderViewTable() {
    const year = Number(document.getElementById('view-year').value);
    const students = await fetchStudentsMap();
    const studs = Object.entries(students)
      .filter(([pin, s]) => Number(s.year) === year)
      .map(([pin, s]) => ({ pin, name: s.name }));

    const totalWorking = await getTotalWorkingDaysSoFar(year);
    const attendance = await fetchAttendance();

    let html = `<p class="small muted">Total working days since 12-06-2025 (for Year ${year}): ${totalWorking}</p>`;
    html += '<table><thead><tr><th>SI No</th><th>PIN</th><th>Name</th><th>Days Present</th><th>Percentage</th></tr></thead><tbody>';

    studs.forEach((s, idx) => {
      let present = 0;
      for (const k in attendance) {
        const sessionsYears = attendance[k];
        if (sessionsYears) {
          const yrRec = sessionsYears[year];
          if (yrRec && yrRec.present && yrRec.present[s.pin]) {
            present += 0.5;
          }
        }
      }

      const presentDisplay = Number.isInteger(present) ? present.toString() : present.toFixed(1);
      const percent = totalWorking === 0 ? 0 : Math.round((present / totalWorking) * 100);

      html += `<tr>
        <td>${idx + 1}</td>
        <td>${s.pin}</td>
        <td>${s.name}</td>
        <td>${presentDisplay}</td>
        <td>${percent}%</td>
      </tr>`;
    });

    html += '</tbody></table>';
    document.getElementById('view-table-area').innerHTML = html;
  }

  async function renderEditTable(){
    const students = await fetchStudentsMap();
    const years = [1,2,3];
    let html = '';
    for(const y of years){
      const studs = Object.entries(students).filter(([pin,s]) => Number(s.year)===y).map(([pin,s]) => ({ pin, name: s.name }));
      html += `<h4>Year ${y}</h4>`;
      if(studs.length === 0){
        html += `<p class="muted">No students found for Year ${y}.</p><div style="height:12px"></div>`;
        continue;
      }
      html += '<table><thead><tr><th>SI No</th><th>PIN</th><th>Name</th><th>Action</th></tr></thead><tbody>';
      studs.forEach((s,idx)=>{ html += `<tr><td>${idx+1}</td><td>${s.pin}</td><td>${s.name}</td><td><button class="btn danger" onclick="deleteStudent('${s.pin}')">Delete</button></td></tr>`; });
      html += '</tbody></table><div style="height:12px"></div>';
    }
    document.getElementById('edit-table-area').innerHTML = html;
  }

  async function addStudentFromForm(){
    const session = getSessionForNow();
    if (session !== "AM") {
      alert("Student registration is allowed only in the morning session.\nPlease add this student tomorrow morning.");
      return;
    }
    const pin = document.getElementById('new-pin').value.trim();
    const name = document.getElementById('new-name').value.trim();
    const year = Number(document.getElementById('new-year').value);
    if(!pin || !name){ alert('Enter valid details'); return; }
    const studentRef = ref(db, `students/${pin}`);
    const snap = await get(studentRef);
    if(snap.exists()){ alert('PIN already exists'); return; }
    await set(studentRef, { name, year });
    document.getElementById('add-student-form').reset();
    await renderEditTable();
    alert('Student added');
  }

  async function deleteStudent(pin){
    if(!confirm('Delete student with PIN '+pin+'?')) return;
    await remove(ref(db, `students/${pin}`));
    const attendance = await fetchAttendance();
    const updates = {};
    for(const k in attendance){
      const rec = attendance[k];
      for(const yr in rec){
        if(rec[yr] && rec[yr].present && rec[yr].present[pin]){
          updates[`attendance/${k}/${yr}/present/${pin}`] = null;
        }
      }
    }
    if(Object.keys(updates).length>0){
      await update(ref(db), updates);
    }
    await renderEditTable();
  }

  // Student lookup & weekly table
  async function studentLookup(){
    const pin = document.getElementById('student-pin-input').value.trim(); if(!pin){ alert('Enter PIN'); return; }
    const studentSnap = await get(ref(db, `students/${pin}`));
    if(!studentSnap.exists()){ document.getElementById('student-result').innerHTML = `<p class="note">No student found with PIN ${pin}</p>`; return; }
    const s = studentSnap.val();
    const attendance = await fetchAttendance();
    const totalWorking = await getTotalWorkingDaysSoFar(Number(s.year));
    let present = 0;
    for(const k in attendance){
      const sessionsYears = attendance[k];
      if (sessionsYears) {
        const yrRec = sessionsYears[s.year];
        if (yrRec && yrRec.present && yrRec.present[pin]) {
          present+=0.5;
        }
      }
    }
    const presentDisplay = Number.isInteger(present) ? present.toString() : present.toFixed(1);
    const percent = totalWorking===0?0:Math.round((present/(totalWorking))*100);
    let html = `<h3>${s.name} (Year ${s.year})</h3>`;
    html += `<table><tr><th class="small">Total Days Present</th><td>${presentDisplay}</td>
</tr><tr><th class="small">Total Working Days</th><td>${totalWorking}</td></tr><tr><th class="small">Percentage</th><td>${percent}%</td></tr></table>`;
    html += '<div style="height:12px"></div><h4>Weekly Attendance (Mon - Sat)</h4>' + await generateWeeklyTableForPin(pin);
    document.getElementById('student-result').innerHTML = html;
  }

  async function generateWeeklyTableForPin(pin) {
    const attendance = await fetchAttendance();
    const studentSnap = await get(ref(db, `students/${pin}`));
    const studentYear = studentSnap.exists() ? studentSnap.val().year : null;

    const today = new Date();
    const day = today.getDay();
    const diff = (day + 6) % 7; // monday offset
    const monday = new Date(today);
    monday.setDate(today.getDate() - diff);

    let html = '<table><thead><tr><th>Day</th><th>Date</th><th>Status</th></tr></thead><tbody>';

    for (let i = 0; i < 6; i++) {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);

      const y = d.getFullYear(), mo = String(d.getMonth() + 1).padStart(2,'0'), da = String(d.getDate()).padStart(2,'0');

      const keyAM = `${y}-${mo}-${da}_AM`;
      const keyPM = `${y}-${mo}-${da}_PM`;
      const dateKey = `${y}-${mo}-${da}`;

      const amHoliday = attendance[keyAM]?.[studentYear]?.holiday || false;
      const pmHoliday = attendance[keyPM]?.[studentYear]?.holiday || false;

      const amPresent = attendance[keyAM]?.[studentYear]?.present?.[pin] || false;
      const pmPresent = attendance[keyPM]?.[studentYear]?.present?.[pin] || false;

      const fullDay = attendance[dateKey]?.[studentYear]?.fullDayHoliday || false;

      let status = "";

      if (fullDay) {
        status = `<span style="color:#0284c7;font-weight:700">HLD</span>`;
      } else if (amPresent && pmPresent) {
        status = `<span class="status-p">P</span>`;
      } else if (amPresent || pmPresent) {
        status = `<span class="status-p">H</span>`;
      } else if (amHoliday || pmHoliday) {
        // if holiday and no present -> treat as half-day holiday (H)
        status = `<span class="status-p">H</span>`;
      } else {
        status = `<span class="status-a">A</span>`;
      }

      html += `<tr><td>${['Mon','Tue','Wed','Thu','Fri','Sat'][i]}</td><td>${da}-${mo}-${y}</td><td>${status}</td></tr>`;
    }

    html += '</tbody></table>';
    return html;
  }

  // CSV export
  async function exportCSV(){
    const year=Number(document.getElementById('view-year').value);
    const students = await fetchStudentsMap();
    const studs = Object.entries(students).filter(([pin,s]) => Number(s.year)===year).map(([pin,s]) => ({ pin, name: s.name }));
    const attendance = await fetchAttendance();
    const totalWorking = await getTotalWorkingDaysSoFar(year);
    let csv='PIN,Name,DaysPresent,TotalWorkingDays,Percentage\n';
    for(const s of studs){
      let present=0;
      for(const k in attendance){
        const sessionYears = attendance[k];
        if(sessionYears && sessionYears[year] && sessionYears[year].present && sessionYears[year].present[s.pin]) present+=0.5;
      }
      const percent = totalWorking===0?0:Math.round((present/(totalWorking))*100);
      csv += `${s.pin},"${s.name}",${present},${totalWorking},${percent}%\n`;
    }
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`attendance_year${year}.csv`; a.click(); URL.revokeObjectURL(url);
  }

  // Initialization
  (async function init(){
    backHome();
    await renderEditTable();
    window._firebaseDebug = { fetchStudentsMap, fetchAttendance, renderEditTable };
  })();

  // Expose functions
  window.openStudent = openStudent;
  window.openFaculty = openFaculty;
  window.backHome = backHome;
  window.facultyLogin = facultyLogin;
  window.clearFaculty = clearFaculty;
  window.logoutFaculty = logoutFaculty;
  window.showSection = showSection;
  window.renderMarkTable = renderMarkTable;
  window.saveMarks = saveMarks;
  window.markHoliday = markHoliday;
  window.renderViewTable = renderViewTable;
  window.renderEditTable = renderEditTable;
  window.addStudentFromForm = addStudentFromForm;
  window.deleteStudent = deleteStudent;
  window.studentLookup = studentLookup;
  window.exportCSV = exportCSV;

</script>
</body>
</html>
