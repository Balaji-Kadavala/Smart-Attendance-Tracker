<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Attendance Tracker</title>
<link rel="icon" href="Facial_Recognition-removebg.png" />
<!-- Modern Attractive Theme -->
<style>
:root{
  --bg:#eef2ff;
  --card:#ffffff;
  --primary:#6366f1;
  --primary-dark:#4f46e5;
  --text:#111827;
  --muted:#6b7280;
  --danger:#ef4444;
  --success:#16a34a;
  --radius:14px;
  font-family:Inter, sans-serif;
}
body{
  background:linear-gradient(180deg,#eef2ff,#e0e7ff);
  margin:0;color:var(--text);
}
.container{
  max-width:960px;
  margin:32px auto;
  padding:16px;
}
/* CARD */
.card{
  background:var(--card);
  padding:20px;
  border-radius:var(--radius);
  box-shadow:0 6px 20px rgba(0,0,0,.08);
}
/* HEADER */
header{display:flex;gap:12px;align-items:center;margin-bottom:22px}
.logo{width:60px;height:60px;border-radius:14px;overflow:hidden;border:2px solid #c7d2fe;display:flex;align-items:center;justify-content:center;background:#fff}
.logo img{width:100%;height:100%;object-fit:contain}
/* ROLE BUTTONS */
.role-btn{
  background:var(--primary);
  color:white;
  padding:14px 18px;
  min-width:140px;
  border-radius:12px;
  font-size:15px;
  font-weight:600;
}
.role-btn:hover{transform:scale(1.03);background:var(--primary-dark)}
/* TABS */
.tab-btn{
  padding:8px 14px;
  background:#e0e7ff;
  border-radius:10px;
  margin-right:6px;
  font-size:14px;
}
.tab-btn.active{
  background:var(--primary);
  color:#fff;
  transform:translateY(-2px);
}
/* BUTTONS */
.btn.primary{
  background:var(--primary);
  color:white;
  padding:8px 14px;
  font-size:14px;
}
.btn.ghost{
  background:#f3f4f6;
  padding:8px 14px;
}
.btn.danger{
  background:var(--danger);
  color:white;
  padding:6px 12px;
  font-size:13px;
  border-radius:10px;
}
/* INPUTS */
input,select{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-size:14px;
  width:100%;
  max-width:260px;
}
input:focus,select:focus{outline:2px solid var(--primary)}
.form-row{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.form-row > *{
  flex:1 1 auto;
  min-width:120px;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:14px;
  font-size:14px;
}
th{
  background:#eef2ff;
  padding:10px;
  text-align:left;
}
td{
  padding:8px;
  border-bottom:1px solid #e5e7eb;
}
table-wrapper{ overflow-x:auto; }
tr:hover{background:#f5f5ff}
.status-p{color:var(--success);font-weight:700}
.status-a{color:var(--danger);font-weight:700}
.hidden{display:none}
.flex{display:flex;gap:10px;align-items:center}
.right{margin-left:auto}
.note{color:var(--muted);font-size:13px}
.small{font-size:13px}
.muted{color:var(--muted)}
/* MOBILE */
@media(max-width:600px){
  .container{ padding:10px; margin:10px; }
  .card{ padding:16px; }
  header h1{ font-size:20px; text-align:center; }
  .role-btn{ width:100%; font-size:14px; }
  .tab-btn{ width:100%; margin-bottom:6px; }
  input, select{ width:100%; max-width:100%; }
  .flex{ flex-wrap:wrap; }
  .right{ margin-left:0; }
  table{ font-size:13px; }
  th,td{ padding:8px; }
  #mark-table-area, #view-table-area, #edit-table-area{ overflow-x:auto; }
}
</style>
</head>
<body>
<div class="container">
<header>
 <div class="logo"><img src="Facial_Recognition-removebg.png" alt="logo"></div>
 <h1>Smart Attendance Tracker</h1>
</header>

<!-- HOME -->
<div id="home" class="card">
 <h2 style="text-align:center;margin-top:0">Welcome ‚Äî Choose Role</h2>
 <p style="text-align:center;color:var(--muted);margin-top:-4px">Use Student for personal view. Faculty will mark and manage attendance.</p>
 <div style="display:flex;gap:20px;justify-content:center;margin-top:20px;flex-wrap:wrap">
   <button id="btn-student" class="role-btn" onclick="openStudent()">Student</button>
   <button id="btn-faculty" class="role-btn" onclick="openFaculty()">Faculty</button>
 </div>
</div>

<!-- FACULTY LOGIN -->
<div id="faculty-login" class="card hidden">
 <div class="flex">
   <strong>Faculty Login</strong>
   <button class="btn ghost right" onclick="backHome()">‚¨Ö Back</button>
 </div>
 <div style="margin-top:12px">
   <label>Username</label>
   <input id="fac-user" placeholder="Enter username" />
 </div>
 <div style="margin-top:10px">
   <label>Password</label>
   <input id="fac-pass" type="password" placeholder="Enter password" />
 </div>
 <div class="flex" style="margin-top:14px">
   <button class="btn primary" onclick="facultyLogin()">Login</button>
   <button class="btn ghost" onclick="clearFaculty()">Clear</button>
 </div>
</div>

<!-- FACULTY DASHBOARD -->
<div id="faculty-dash" class="card hidden">
 <div class="flex" style="justify-content:space-between">
   <strong>Faculty Dashboard</strong>
   <button class="btn ghost" onclick="logoutFaculty()">Logout</button>
 </div>

 <div style="margin-top:14px">
   <button id="tab-mark" class="tab-btn" onclick="showSection('mark')">üìù Mark Attendance</button>
   <button id="tab-view" class="tab-btn" onclick="showSection('view')">üìä View Attendance</button>
   <button id="tab-edit" class="tab-btn" onclick="showSection('edit')">üë• Edit Students</button>
 </div>

 <!-- MARK -->
 <div id="section-mark" class="hidden" style="margin-top:18px">
   <div class="flex" style="align-items:center">
     <label>Choose Year:</label>
     <select id="mark-year" onchange="renderMarkTable()"><option value="1">1st</option><option value="2">2nd</option><option value="3">3rd</option></select>
     <span id="session-label" class="small" style="margin-left:8px"></span>
     <button id="save-marks" class="btn primary right" onclick="saveMarks()">Save</button>
   </div>
   <div id="mark-table-area"></div>
 </div>

 <!-- VIEW -->
<div id="section-view" class="hidden" style="margin-top:18px">
 <div class="flex">
    <label>Choose Year:</label>
    <select id="view-year" onchange="renderViewTable()">
       <option value="1">1st</option>
       <option value="2">2nd</option>
       <option value="3">3rd</option>
    </select>
    <button class="btn primary right" onclick="exportCSV()">Download CSV</button>
 </div>
 <div id="view-table-area" style="margin-top:10px"></div>
</div>

<!-- EDIT -->
<div id="section-edit" class="hidden" style="margin-top:18px">
 <form id="add-student-form" onsubmit="event.preventDefault(); addStudentFromForm()">
   <div class="form-row" style="margin-top:8px">
     <input id="new-pin" type="text" class="pin-input" placeholder="PIN (e.g. 25183-CM-001)" required />
     <input id="new-name" type="text" placeholder="Student name" required />
     <select id="new-year"><option value="1">1st</option><option value="2">2nd</option><option value="3">3rd</option></select>
     <button class="btn primary" type="submit">Add</button>
   </div>
 </form>
 <div id="edit-table-area" style="margin-top:12px"></div>
</div>

<!-- STUDENT -->
<div id="student-screen" class="card hidden" style="margin-top:16px">
 <div class="flex"><strong>Enter PIN</strong><button class="btn ghost right" onclick="backHome()">Back</button></div>
 <div class="flex" style="margin-top:14px">
   <input id="student-pin-input" placeholder="25183-CM-001" />
   <button class="btn primary" onclick="studentLookup()">Go</button>
 </div>
 <div id="student-result" style="margin-top:14px"></div>
</div>

</div>


<script type="module">
// ---------- Firebase Init and DB helper functions ----------
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, get, set, update, push, onValue, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

// --- Firebase config (your config) ---
const firebaseConfig = {
  apiKey: "AIzaSyCNGm7gErFVFS-zmd2zhnOGDBHqzK7hwUA",
  authDomain: "smart-attendance-tracker-dc3e0.firebaseapp.com",
  projectId: "smart-attendance-tracker-dc3e0",
  storageBucket: "smart-attendance-tracker-dc3e0.firebasestorage.app",
  messagingSenderId: "874135444986",
  appId: "1:874135444986:web:11676820f7fe7fc6ab5843",
  measurementId: "G-43FXHWMGZY"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ---------- Simple DB helpers (Option A - PIN as key) ----------
// path examples:
// 'students' -> object of pins
// 'students/23183-CM-001' -> { name, year }
// 'attendance/2025-11-19_AM/present/23183-CM-001' -> true
// 'attendance/2025-11-19_AM/locked' -> true

async function dbGet(path) {
  const snap = await get(ref(db, path));
  return snap.exists() ? snap.val() : null;
}
async function dbSet(path, value) {
  return set(ref(db, path), value);
}
async function dbUpdate(path, valueObj) {
  return update(ref(db, path), valueObj);
}
async function dbPush(path, value) {
  return push(ref(db, path), value);
}
function dbOnValue(path, callback) {
  return onValue(ref(db, path), (snap) => { callback(snap.exists() ? snap.val() : null); });
}
async function dbRemovePath(path){
  return remove(ref(db, path));
}

// ---------- Seed default data if empty ----------
async function seedIfEmptyFirebase() {
  const students = await dbGet('students');
  if (!students) {
    // default students (same as previous localStorage seed)
    const defaultStudents = {
      "23183-CM-001": { name: "Ravi Kumar", year: 1 },
      "23183-CM-002": { name: "Sita Reddy", year: 1 },
      "24183-CM-001": { name: "Anil Shah", year: 2 },
      "24183-CM-002": { name: "Geeta Devi", year: 2 },
      "23183-CM-003": { name: "Mohan Das", year: 3 }
    };
    await dbSet('students', defaultStudents);
  }
  // Ensure attendance node exists (empty object) to avoid null checks
  const attendance = await dbGet('attendance');
  if (!attendance) {
    await dbSet('attendance', {});
  }
}

// call seed on load (fire-and-forget)
seedIfEmptyFirebase().catch(err => console.error('Seed error', err));

// expose helpers to window for debugging if needed
window._fb = { dbGet, dbSet, dbUpdate, dbPush, dbOnValue, dbRemovePath };
</script>

<script type="module">
/* ---------- App logic (Firebase-backed) ---------- */
// Reuse helper functions exposed in Part 2
const { dbGet, dbSet, dbUpdate } = window._fb;

// ---------- Constants & Session logic ----------
const ACADEMIC_START = new Date(2025,5,12); // June 12, 2025 (month index 5)
function academicEndForStart(){ return new Date(ACADEMIC_START.getFullYear()+1,3,30); }
function countWorkingDays(from, to){
  let count=0; const d=new Date(from);
  while(d<=to){ if(d.getDay()!==0) count++; d.setDate(d.getDate()+1); }
  return count;
}
function getTotalWorkingDaysSoFar(){
  const now=new Date(); const end = academicEndForStart();
  const upto = now<end ? now : end; if(upto<ACADEMIC_START) return 0;
  return countWorkingDays(ACADEMIC_START, upto);
}
function getSessionForNow(){
  const d=new Date(); const h=d.getHours(); const m=d.getMinutes();
  const minutes = h*60 + m;
  const amStart = 10*60; const amEnd = 13*60 + 20;
  const pmStart = 14*60; const pmEnd = 16*60 + 30;
  if(minutes>=amStart && minutes<=amEnd) return 'AM';
  if(minutes>=pmStart && minutes<=pmEnd) return 'PM';
  return null;
}
function todayKey(session){
  const d=new Date(); const y=d.getFullYear(); const mo=String(d.getMonth()+1).padStart(2,'0');
  const da=String(d.getDate()).padStart(2,'0'); return `${y}-${mo}-${da}_${session}`;
}

// ---------- UI helpers ----------
function hideAll(){ document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden')); }
function backHome(){ hideAll(); document.getElementById('home').classList.remove('hidden'); }
function openFaculty(){ hideAll(); document.getElementById('faculty-login').classList.remove('hidden'); }
function openStudent(){ hideAll(); document.getElementById('student-screen').classList.remove('hidden'); }

// Ensure role buttons colors remain OK (safe fallback)
try {
  document.getElementById('btn-student').style.background = getComputedStyle(document.documentElement).getPropertyValue('--primary');
  document.getElementById('btn-student').style.color = '#fff';
  document.getElementById('btn-faculty').style.background = getComputedStyle(document.documentElement).getPropertyValue('--primary');
  document.getElementById('btn-faculty').style.color = '#fff';
} catch(e){}

// ---------- Faculty auth (demo) ----------
function facultyLogin(){
  const u = document.getElementById('fac-user').value.trim();
  const p = document.getElementById('fac-pass').value.trim();
  if(u.length===0 || p.length===0){ alert('Enter both username and password'); return; }
  sessionStorage.setItem('facultyUser', u);
  hideAll(); document.getElementById('faculty-dash').classList.remove('hidden');
  showSection('mark');
}
function clearFaculty(){ document.getElementById('fac-user').value=''; document.getElementById('fac-pass').value=''; }
function logoutFaculty(){ sessionStorage.removeItem('facultyUser'); backHome(); }

// ---------- Tab management ----------
function showSection(name) {
  ['mark','view','edit'].forEach(s => document.getElementById('section-' + s).classList.add('hidden'));
  ['tab-mark','tab-view','tab-edit'].forEach(id => document.getElementById(id).classList.remove('active'));
  document.getElementById('section-' + name).classList.remove('hidden');
  document.getElementById('tab-' + name).classList.add('active');
  if (name === 'mark') renderMarkTable();
  if (name === 'view') renderViewTable();
  if (name === 'edit') renderEditTable();
}

// ---------- Render Mark Table ----------
async function renderMarkTable(){
  const year=Number(document.getElementById('mark-year').value);
  const session = getSessionForNow();
  document.getElementById('session-label').innerText = `Session: ${session || 'None'}`;
  const allStudents = await dbGet('students') || {};
  // filter students by year and sort by pin lexicographically for stable order
  const studs = Object.entries(allStudents).filter(([pin, s]) => Number(s.year) === year).sort((a,b)=>a[0].localeCompare(b[0]));
  const key = session ? todayKey(session) : null;
  const attendanceRec = key ? (await dbGet(`attendance/${key}`) || {}) : {};
  const presentObj = attendanceRec.present || {};
  const locked = !!attendanceRec.locked;
  let html = '';
  if(!session){
    html += '<p class="note">Current time is outside marking windows. Student list is hidden until session opens.</p>';
    document.getElementById('mark-table-area').innerHTML = html;
    document.getElementById('save-marks').disabled=true;
    return;
  }
  html += '<table><thead><tr><th>SI No</th><th>PIN</th><th>Name</th><th>Present</th></tr></thead><tbody>';
  studs.forEach(([pin, s], idx) => {
    const checked = presentObj[pin] ? 'checked' : '';
    const disabled = locked ? 'disabled' : '';
    html += `<tr class="${locked? 'locked':''}"><td>${idx+1}</td><td>${pin}</td><td>${s.name}</td><td><input data-pin="${pin}" type="checkbox" ${checked} ${disabled}></td></tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('mark-table-area').innerHTML = html;
  document.getElementById('save-marks').disabled = locked;
}

// ---------- Save marks (lock attendance for session) ----------
async function saveMarks(){
  const session = getSessionForNow(); if(!session){ alert('Cannot save outside session times'); return; }
  const key = todayKey(session);
  const attendanceRec = await dbGet(`attendance/${key}`) || {};
  if(attendanceRec.locked){ alert('Attendance already saved and locked for this session'); return; }
  const checkboxes = document.querySelectorAll('#mark-table-area input[type="checkbox"]');
  const presentObj = {};
  checkboxes.forEach(cb => { if(cb.checked) presentObj[cb.dataset.pin] = true; });
  // write present and locked = true
  await dbSet(`attendance/${key}`, { locked: true, present: presentObj });
  alert('Attendance saved and locked for ' + key);
  renderMarkTable();
}

// ---------- View Attendance ----------
async function getTotalSessionsForYear(year){
  const attendance = await dbGet('attendance') || {};
  const allStudents = await dbGet('students') || {};
  const yearPins = new Set(Object.entries(allStudents).filter(([,s])=>Number(s.year)===year).map(([pin])=>pin));
  let count = 0;
  for (const k in attendance){
    const rec = attendance[k];
    if(!rec) continue;
    // if any present pin in this rec intersects yearPins
    const present = rec.present || {};
    for(const p in present){ if(yearPins.has(p)){ count++; break; } }
  }
  return count;
}
async function renderViewTable(){
  const year = Number(document.getElementById('view-year').value);
  const allStudents = await dbGet('students') || {};
  const studs = Object.entries(allStudents).filter(([,s])=>Number(s.year)===year).sort((a,b)=>a[0].localeCompare(b[0]));
  const attendance = await dbGet('attendance') || {};
  const totalWorking = getTotalWorkingDaysSoFar();
  let html = `<p class="small muted">Total working days since 12-06-2025: ${totalWorking}</p>`;
  html += '<table><thead><tr><th>SI No</th><th>PIN</th><th>Name</th><th>Days Present</th><th>Percentage</th></tr></thead><tbody>';
  studs.forEach(([pin, s], idx) => {
    let present = 0;
    for(const k in attendance){ if(attendance[k].present && attendance[k].present[pin]) present++; }
    const percent = totalWorking === 0 ? 0 : Math.round((present / totalWorking) * 100);
    html += `<tr><td>${idx+1}</td><td>${pin}</td><td>${s.name}</td><td>${present}</td><td>${percent}%</td></tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('view-table-area').innerHTML = html;
}

// ---------- Edit Students (per year) ----------
async function renderEditTable(){
  const allStudents = await dbGet('students') || {};
  const years=[1,2,3]; 
  let html='';

  years.forEach(y=>{
    const studs = Object.entries(allStudents)
                .filter(([,s])=>Number(s.year)===y)
                .sort((a,b)=>a[0].localeCompare(b[0]));

    html += `<h4>Year ${y}</h4>`;
    html += `
      <table>
        <thead>
          <tr>
            <th>SI No</th>
            <th>PIN</th>
            <th>Name</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
    `;

    // ‚úÖ FIXED ‚Üí Correct arrow function
    studs.forEach(([pin, s], idx) => {
      html += `
        <tr>
          <td>${idx+1}</td>
          <td>${pin}</td>
          <td>${s.name}</td>
          <td>
            <button class="btn danger" onclick="deleteStudent('${pin}')">Delete</button>
          </td>
        </tr>
      `;
    });

    html += `</tbody></table><div style="height:12px"></div>`;
  });

  document.getElementById('edit-table-area').innerHTML = html;
}


// ---------- Add Student ----------
async function addStudentFromForm(){
  const pin = document.getElementById('new-pin').value.trim();
  const name = document.getElementById('new-name').value.trim();
  const year = Number(document.getElementById('new-year').value);
  if(!pin || !name){ alert('Enter valid details'); return; }
  const existing = await dbGet(`students/${pin}`);
  if(existing){ alert('PIN already exists'); return; }
  await dbSet(`students/${pin}`, { name, year });
  document.getElementById('add-student-form').reset();
  await renderEditTable();
  alert('Student added');
}

// ---------- Delete student ----------
async function deleteStudent(pin){
  if(!confirm('Delete student with PIN '+pin+'?')) return;
  // remove student node
  await dbSet(`students/${pin}`, null); // set null removes
  // remove pin from all attendance present objects
  const attendance = await dbGet('attendance') || {};
  for(const k in attendance){
    const rec = attendance[k];
    if(rec && rec.present && rec.present[pin]){
      // remove the key by setting present/<pin> = null
      await dbSet(`attendance/${k}/present/${pin}`, null);
    }
  }
  await renderEditTable();
}

// ---------- Student lookup & weekly table ----------
async function studentLookup(){
  const pin = document.getElementById('student-pin-input').value.trim();
  if(!pin){ alert('Enter PIN'); return; }
  const s = await dbGet(`students/${pin}`);
  if(!s){ document.getElementById('student-result').innerHTML = `<p class="note">No student found with PIN ${pin}</p>`; return; }
  // count present
  const attendance = await dbGet('attendance') || {};
  let present = 0;
  for(const k in attendance){ if(attendance[k].present && attendance[k].present[pin]) present++; }
  const totalWorking = getTotalWorkingDaysSoFar();
  const percent = totalWorking === 0 ? 0 : Math.round((present / totalWorking) * 100);
  let html = `<h3>${s.name} (Year ${s.year})</h3>`;
  html += `<table><tr><th class="small">Total Days Present</th><td>${present}</td></tr><tr><th class="small">Total Working Days</th><td>${totalWorking}</td></tr><tr><th class="small">Percentage</th><td>${percent}%</td></tr></table>`;
  const weekHtml = await generateWeeklyTableForPin(pin);
  html += '<div style="height:12px"></div><h4>Weekly Attendance (Mon - Sat)</h4>' + weekHtml;
  document.getElementById('student-result').innerHTML = html;
}

async function generateWeeklyTableForPin(pin){
  const attendance = await dbGet('attendance') || {};
  const today = new Date(); const day = today.getDay(); // 0 Sun
  const diff = (day+6)%7; const monday = new Date(today); monday.setDate(today.getDate()-diff);
  let html = '<table><thead><tr><th>Day</th><th>Date</th><th>Status</th></tr></thead><tbody>';
  for(let i=0;i<6;i++){
    const d = new Date(monday); d.setDate(monday.getDate()+i);
    const y=d.getFullYear(), mo=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
    const keyAM=`${y}-${mo}-${da}_AM`; const keyPM=`${y}-${mo}-${da}_PM`;
    const recAM = attendance[keyAM] && attendance[keyAM].present && attendance[keyAM].present[pin];
    const recPM = attendance[keyPM] && attendance[keyPM].present && attendance[keyPM].present[pin];
    const present = recAM || recPM;
    const status = present ? `<span class="status-p">P</span>` : `<span class="status-a">A</span>`;
    html += `<tr><td>${['Mon','Tue','Wed','Thu','Fri','Sat'][i]}</td><td>${da}-${mo}-${y}</td><td>${status}</td></tr>`;
  }
  html += '</tbody></table>';
  return html;
}

// ---------- CSV export ----------
async function exportCSV(){
  const year = Number(document.getElementById('view-year').value);
  const allStudents = await dbGet('students') || {};
  const studs = Object.entries(allStudents).filter(([,s])=>Number(s.year)===year).sort((a,b)=>a[0].localeCompare(b[0]));
  const attendance = await dbGet('attendance') || {};
  const totalWorking = getTotalWorkingDaysSoFar();
  let csv = 'PIN,Name,DaysPresent,TotalWorkingDays,Percentage\n';
  for(const [pin,s] of studs){
    let present = 0;
    for(const k in attendance){ if(attendance[k].present && attendance[k].present[pin]) present++; }
    const percent = totalWorking === 0 ? 0 : Math.round((present / totalWorking) * 100);
    csv += `${pin},"${s.name}",${present},${totalWorking},${percent}%\n`;
  }
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `attendance_year${year}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ---------- Init ----------
backHome();
renderEditTable();

// Expose debug functions (optional)
window._app = {
  renderMarkTable, renderViewTable, renderEditTable, studentLookup, addStudentFromForm, saveMarks, deleteStudent
};

</script>
</body>
</html>


