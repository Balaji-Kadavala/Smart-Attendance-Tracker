<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Attendance Tracker</title>
<link rel="icon" href="C:\SAT\Facial_Recognition-removebg.png" />

<!-- Modern Attractive Theme -->
<style>
:root{
 --bg:#eef2ff;
 --card:#ffffff;
 --primary:#6366f1;
 --primary-dark:#4f46e5;
 --text:#111827;
 --muted:#6b7280;
 --danger:#ef4444;
 --success:#16a34a;
 --radius:14px;
 font-family:Inter, sans-serif;
}

body{
  background:linear-gradient(180deg,#eef2ff,#e0e7ff);
  margin:0;color:var(--text);
}

.container{
  max-width:960px;
  margin:32px auto;
  padding:16px;
}

/* CARD */
.card{
  background:var(--card);
  padding:20px;
  border-radius:var(--radius);
  box-shadow:0 6px 20px rgba(0,0,0,.08);
}

/* HEADER */
header{display:flex;gap:12px;align-items:center;margin-bottom:22px}
.logo{width:60px;height:60px;border-radius:14px;overflow:hidden;border:2px solid #c7d2fe;display:flex;align-items:center;justify-content:center;background:#fff}
.logo img{width:100%;height:100%;object-fit:contain}

/* ROLE BUTTONS */
.role-btn{
  background:var(--primary);
  color:white;
  padding:14px 18px;
  min-width:140px;
  border-radius:12px;
  font-size:15px;
  font-weight:600;
}
.role-btn:hover{transform:scale(1.03);background:var(--primary-dark)}

/* TABS */
.tab-btn{
  padding:8px 14px;
  background:#e0e7ff;
  border-radius:10px;
  margin-right:6px;
  font-size:14px;
}
.tab-btn.active{
  background:var(--primary);
  color:#fff;
  transform:translateY(-2px);
}

/* BUTTONS */
.btn.primary{
  background:var(--primary);
  color:white;
  padding:8px 14px;
  font-size:14px;
}
.btn.ghost{
  background:#f3f4f6;
  padding:8px 14px;
}
.btn.danger{
  background:var(--danger);
  color:white;
  padding:6px 12px;
  font-size:13px;
  border-radius:10px;
}

/* INPUTS */
input,select{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-size:14px;
  width:100%;
  max-width:260px;
}

input:focus,select:focus{outline:2px solid var(--primary)}

.form-row{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.form-row > *{
  flex:1 1 auto;
  min-width:120px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:14px;
  font-size:14px;
}

th{
  background:#eef2ff;
  padding:10px;
  text-align:left;
}

td{
  padding:8px;
  border-bottom:1px solid #e5e7eb;
}

table-wrapper{
  overflow-x:auto;
}

tr:hover{background:#f5f5ff}

.status-p{color:var(--success);font-weight:700}
.status-a{color:var(--danger);font-weight:700}

.hidden{display:none}
.flex{display:flex;gap:10px;align-items:center}
.right{margin-left:auto}

@media(max-width:600px){

  .container{
    padding:10px;
    margin:10px;
  }

  .card{
    padding:16px;
  }

  header h1{
    font-size:20px;
    text-align:center;
  }

  .role-btn{
    width:100%;
    font-size:14px;
  }

  .tab-btn{
    width:100%;
    margin-bottom:6px;
  }

  input, select{
    width:100%;
    max-width:100%;
  }

  .flex{
    flex-wrap:wrap;
  }

  .right{
    margin-left:0;
  }

  table{
    font-size:13px;
  }

  th,td{
    padding:8px;
  }

  #mark-table-area, 
  #view-table-area, 
  #edit-table-area{
    overflow-x:auto;
  }
}
</style>
</head>
<body>
<div class="container">
<header>
 <div class="logo"><img src="C:\SAT\Facial_Recognition-removebg.png" alt="logo"></div>
 <h1>Smart Attendance Tracker</h1>
</header>

<!-- HOME -->
<div id="home" class="card">
 <h2 style="text-align:center;margin-top:0">Welcome ‚Äî Choose Role</h2>
 <p style="text-align:center;color:var(--muted);margin-top:-4px">Use Student for personal view. Faculty will mark and manage attendance.</p>
 <div style="display:flex;gap:20px;justify-content:center;margin-top:20px;flex-wrap:wrap">
   <button id="btn-student" class="role-btn" onclick="openStudent()">Student</button>
   <button id="btn-faculty" class="role-btn" onclick="openFaculty()">Faculty</button>
 </div>
</div>

<!-- FACULTY LOGIN -->
<div id="faculty-login" class="card hidden">
 <div class="flex">
   <strong>Faculty Login</strong>
   <button class="btn ghost right" onclick="backHome()">‚¨Ö Back</button>
 </div>
 <div style="margin-top:12px">
   <label>Username</label>
   <input id="fac-user" placeholder="Enter username" />
 </div>
 <div style="margin-top:10px">
   <label>Password</label>
   <input id="fac-pass" type="password" placeholder="Enter password" />
 </div>
 <div class="flex" style="margin-top:14px">
   <button class="btn primary" onclick="facultyLogin()">Login</button>
   <button class="btn ghost" onclick="clearFaculty()">Clear</button>
 </div>
</div>

<!-- FACULTY DASHBOARD -->
<div id="faculty-dash" class="card hidden">
 <div class="flex" style="justify-content:space-between">
   <strong>Faculty Dashboard</strong>
   <button class="btn ghost" onclick="logoutFaculty()">Logout</button>
 </div>

 <div style="margin-top:14px">
   <button id="tab-mark" class="tab-btn" onclick="showSection('mark')">üìù Mark Attendance</button>
   <button id="tab-view" class="tab-btn" onclick="showSection('view')">üìä View Attendance</button>
   <button id="tab-edit" class="tab-btn" onclick="showSection('edit')">üë• Edit Students</button>
 </div>

 <!-- MARK -->
 <div id="section-mark" class="hidden" style="margin-top:18px">
   <div class="flex" style="align-items:center">
     <label>Choose Year:</label>
     <select id="mark-year" onchange="renderMarkTable()"><option value="1">1st</option><option value="2">2nd</option><option value="3">3rd</option></select>
     <span id="session-label" class="small" style="margin-left:8px"></span>
     <button id="save-marks" class="btn primary right" onclick="saveMarks()">Save</button>
   </div>
   <div id="mark-table-area"></div>
 </div>

 <!-- VIEW -->
<div id="section-view" class="hidden" style="margin-top:18px">
   <div class="flex">
      <label>Choose Year:</label>
      <select id="view-year" onchange="renderViewTable()">
         <option value="1">1st</option>
         <option value="2">2nd</option>
         <option value="3">3rd</option>
      </select>
      <button class="btn primary right" onclick="exportCSV()">Download CSV</button>
   </div>

   <div id="view-table-area" style="margin-top:10px"></div>
</div>

 <!-- EDIT -->
 <div id="section-edit" class="hidden" style="margin-top:18px">
   <form id="add-student-form" onsubmit="event.preventDefault(); addStudentFromForm()">
     <div class="form-row" style="margin-top:8px">
       <input id="new-pin" type="text" class="pin-input" placeholder="PIN (e.g. 25183-CM-001)" required />
       <input id="new-name" type="text" placeholder="Student name" required />
       <select id="new-year"><option value="1">1st</option><option value="2">2nd</option><option value="3">3rd</option></select>
       <button class="btn primary" type="submit">Add</button>
     </div>
   </form>
   <div id="edit-table-area" style="margin-top:12px"></div>
 </div>
</div>

<!-- STUDENT -->
<div id="student-screen" class="card hidden" style="margin-top:16px">
 <div class="flex"><strong>Enter PIN</strong><button class="btn ghost right" onclick="backHome()">Back</button></div>
 <div class="flex" style="margin-top:14px">
   <input id="student-pin-input" placeholder="25183-CM-001" />
   <button class="btn primary" onclick="studentLookup()">Go</button>
 </div>
 <div id="student-result" style="margin-top:14px"></div>
</div>

</div>

<!-- ==============================
     FIREBASE + APP LOGIC
================================= -->
<script type="module">

/* -------------------------
   FIREBASE SETUP
-------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
import { 
  getDatabase, 
  ref, 
  set 
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCNGm7gErFVFS-zmd2zhnOGDBHqzK7hwUA",
  authDomain: "smart-attendance-tracker-dc3e0.firebaseapp.com",
  projectId: "smart-attendance-tracker-dc3e0",
  storageBucket: "smart-attendance-tracker-dc3e0.firebasestorage.app",
  messagingSenderId: "874135444986",
  appId: "1:874135444986:web:11676820f7fe7fc6ab5843",
  measurementId: "G-43FXHWMGZY",
  databaseURL: "https://smart-attendance-tracker-dc3e0-default-rtdb.firebaseio.com/"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getDatabase(app);

/* ---------- Helper: Save full data to Firebase ---------- */
function syncToFirebase(fullData) {
  set(ref(db, "smartStudents_v2"), fullData)
    .then(() => console.log("Firebase sync OK"))
    .catch(err => console.error("Firebase sync error:", err));
}

/* -------------------------
   ORIGINAL APP CODE BELOW
   (UNCHANGED)
-------------------------- */

const STORAGE_KEY = 'smartStudents_v2';

function seedIfEmpty(){
  if(!localStorage.getItem(STORAGE_KEY)){
    const data = { 
      students:[
        {pin:'23183-CM-001',name:'Ravi Kumar',year:1},
        {pin:'23183-CM-002',name:'Sita Reddy',year:1},
        {pin:'24183-CM-001',name:'Anil Shah',year:2},
        {pin:'24183-CM-002',name:'Geeta Devi',year:2},
        {pin:'23183-CM-003',name:'Mohan Das',year:3}
      ], 
      attendance:{} 
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

    // also store initial data to firebase
    syncToFirebase(data);
  }
}
seedIfEmpty();

function getData(){ 
  return JSON.parse(localStorage.getItem(STORAGE_KEY)); 
}

/* UPDATED: saveData NOW ALSO saves to Firebase */
function saveData(d){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
  syncToFirebase(d); // üî• auto sync always
}

/* ------------------------
   Rest of your original JS
------------------------- */

/* UI helpers */
function hideAll(){document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));}
function backHome(){hideAll(); document.getElementById('home').classList.remove('hidden');}
function openFaculty(){hideAll(); document.getElementById('faculty-login').classList.remove('hidden');}
function openStudent(){hideAll(); document.getElementById('student-screen').classList.remove('hidden');}

document.getElementById('btn-student').style.background = getComputedStyle(document.documentElement).getPropertyValue('--accent');
document.getElementById('btn-student').style.color = '#fff';
document.getElementById('btn-faculty').style.background = getComputedStyle(document.documentElement).getPropertyValue('--accent');
document.getElementById('btn-faculty').style.color = '#fff';

/* Faculty auth */
function facultyLogin(){
  const u = document.getElementById('fac-user').value.trim();
  const p = document.getElementById('fac-pass').value.trim();
  if(u.length===0 || p.length===0){ alert('Enter both username and password'); return; }
  sessionStorage.setItem('facultyUser', u);
  hideAll(); document.getElementById('faculty-dash').classList.remove('hidden');
  showSection('mark');
}
function clearFaculty(){ document.getElementById('fac-user').value=''; document.getElementById('fac-pass').value=''; }
function logoutFaculty(){ sessionStorage.removeItem('facultyUser'); backHome(); }

/* Sections */
function showSection(name){
  ['mark','view','edit'].forEach(s=>document.getElementById('section-'+s).classList.add('hidden'));
  document.getElementById('section-'+name).classList.remove('hidden');
  if(name==='mark') renderMarkTable();
  if(name==='view') renderViewTable();
  if(name==='edit') renderEditTable();
}

/* Session Logic */
function getSessionForNow(){
  const d=new Date(); const h=d.getHours(); const m=d.getMinutes();
  const minutes = h*60 + m;
  const amStart = 10*60; const amEnd = 13*60 + 20;
  const pmStart = 14*60; const pmEnd = 16*60 + 30;
  if(minutes>=amStart && minutes<=amEnd) return 'AM';
  if(minutes>=pmStart && minutes<=pmEnd) return 'PM';
  return null;
}
function todayKey(session){
  const d=new Date(); 
  const y=d.getFullYear(); 
  const mo=String(d.getMonth()+1).padStart(2,'0'); 
  const da=String(d.getDate()).padStart(2,'0'); 
  return `${y}-${mo}-${da}_${session}`;
}

/* Academic Days */
const ACADEMIC_START = new Date(2025,5,12);

function academicEndForStart(){
  const end = new Date(ACADEMIC_START.getFullYear()+1,3,30); return end;
}

function countWorkingDays(from, to){
  let count=0; const d=new Date(from);
  while(d<=to){
    if(d.getDay()!==0) count++;
    d.setDate(d.getDate()+1);
  }
  return count;
}

function getTotalWorkingDaysSoFar(){
  const now=new Date(); const end = academicEndForStart();
  const upto = now<end ? now : end;
  if(upto<ACADEMIC_START) return 0;
  return countWorkingDays(ACADEMIC_START, upto);
}

/* Mark Attendance Table */
function renderMarkTable(){
  const year=Number(document.getElementById('mark-year').value);
  const session = getSessionForNow();
  const sessionLabel = session || 'None';
  document.getElementById('session-label').innerText = `Session: ${sessionLabel}`;
  const data=getData(); 
  const studs = data.students.filter(s=>s.year===year);
  const key = session ? todayKey(session) : null;
  const presentList = key && data.attendance[key] ? data.attendance[key].present : [];
  const locked = key && data.attendance[key] && data.attendance[key].locked;

  let html = '';
  if(!session){
    html += '<p class="note">Current time is outside marking windows.</p>';
    document.getElementById('mark-table-area').innerHTML = html;
    document.getElementById('save-marks').disabled=true; 
    return;
  }

  html += '<table><thead><tr><th>SI No</th><th>PIN</th><th>Name</th><th>Present</th></tr></thead><tbody>';
  studs.forEach((s,idx)=>{
    const checked = presentList.includes(s.pin) ? 'checked' : '';
    const disabled = locked ? 'disabled' : '';
    html += `<tr><td>${idx+1}</td><td>${s.pin}</td><td>${s.name}</td><td><input data-pin="${s.pin}" type="checkbox" ${checked} ${disabled}></td></tr>`;
  });
  html += '</tbody></table>';

  document.getElementById('mark-table-area').innerHTML = html;
  document.getElementById('save-marks').disabled = locked;
}

function saveMarks(){
  const session = getSessionForNow(); 
  if(!session){ alert('Cannot save outside session times'); return; }

  const key = todayKey(session); 
  const data = getData();

  if(data.attendance[key] && data.attendance[key].locked){
    alert('Attendance already saved'); 
    return; 
  }

  const checkboxes = document.querySelectorAll('#mark-table-area input[type="checkbox"]'); 
  const present=[];
  checkboxes.forEach(cb=>{ if(cb.checked) present.push(cb.dataset.pin); });

  data.attendance[key] = {locked:true, present};
  saveData(data);
  alert('Attendance saved');
  renderMarkTable();
}

/* View Attendance */
function renderViewTable(){
  const year = Number(document.getElementById('view-year').value);
  const data = getData();
  const studs = data.students.filter(s => s.year === year);

  const totalWorking = getTotalWorkingDaysSoFar();

  let html = `<p class="small muted">Total working days since 12-06-2025: ${totalWorking}</p>`;

  html += '<table><thead><tr><th>SI No</th><th>PIN</th><th>Name</th>' +
          '<th>Days Present</th><th>Percentage</th></tr></thead><tbody>';

  studs.forEach((s, idx) => {
    let present = 0;
    for (const k in data.attendance) {
      if(data.attendance[k].present.includes(s.pin)) present++;
    }
    const percent = totalWorking === 0 ? 0 : Math.round((present / totalWorking) * 100);

    html += `<tr>
               <td>${idx + 1}</td>
               <td>${s.pin}</td>
               <td>${s.name}</td>
               <td>${present}</td>
               <td>${percent}%</td>
             </tr>`;
  });

  html += '</tbody></table>';

  document.getElementById('view-table-area').innerHTML = html;
}

/* Edit Students */
function renderEditTable(){
  const data=getData(); const years=[1,2,3]; 
  let html='';
  years.forEach(y=>{
    const studs = data.students.filter(s=>s.year===y);
    html += `<h4>Year ${y}</h4>`;
    html += '<table><thead><tr><th>SI No</th><th>PIN</th><th>Name</th><th>Action</th></tr></thead><tbody>';
    studs.forEach((s,idx)=>{
      html += `<tr><td>${idx+1}</td><td>${s.pin}</td><td>${s.name}</td><td><button class="btn danger" onclick="deleteStudent('${s.pin}')">Delete</button></td></tr>`;
    });
    html += '</tbody></table><div style="height:12px"></div>';
  });
  document.getElementById('edit-table-area').innerHTML = html;
}

function addStudentFromForm(){
  const pin = document.getElementById('new-pin').value.trim(); 
  const name=document.getElementById('new-name').value.trim(); 
  const year=Number(document.getElementById('new-year').value);

  if(!pin || !name){ alert('Enter valid details'); return; }

  const data=getData(); 
  if(data.students.some(s=>s.pin===pin)){ alert('PIN already exists'); return; }

  data.students.push({pin,name,year}); 
  saveData(data); 
  document.getElementById('add-student-form').reset(); 
  renderEditTable(); 
  alert('Student added');
}

function deleteStudent(pin){
  if(!confirm('Delete student with PIN '+pin+'?')) return; 
  const data=getData(); 
  data.students = data.students.filter(s=>s.pin!==pin); 
  for(const k in data.attendance){ 
    data.attendance[k].present = data.attendance[k].present.filter(p=>p!==pin); 
  }
  saveData(data); 
  renderEditTable();
}

/* Student Lookup */
function studentLookup(){
  const pin = document.getElementById('student-pin-input').value.trim(); 
  if(!pin){ alert('Enter PIN'); return; }
  const data=getData(); 
  const s = data.students.find(x=>x.pin===pin);

  if(!s){
    document.getElementById('student-result').innerHTML = `<p class="note">No student found with PIN ${pin}</p>`;
    return;
  }

  const totalWorking = getTotalWorkingDaysSoFar(); 
  let present=0; 
  for(const k in data.attendance){ 
    if(data.attendance[k].present.includes(s.pin)) present++; 
  }
  const percent = totalWorking===0 ? 0 : Math.round((present/totalWorking)*100);

  let html = `<h3>${s.name} (Year ${s.year})</h3>`;
  html += `<table>
             <tr><th>Total Days Present</th><td>${present}</td></tr>
             <tr><th>Total Working Days</th><td>${totalWorking}</td></tr>
             <tr><th>Percentage</th><td>${percent}%</td></tr>
           </table>`;

  html += '<div style="height:12px"></div><h4>Weekly Attendance (Mon - Sat)</h4>';
  html += generateWeeklyTableForPin(pin);

  document.getElementById('student-result').innerHTML = html;
}

function generateWeeklyTableForPin(pin){
  const data=getData(); 
  const today=new Date(); 
  const day = today.getDay();

  const diff = (day+6)%7; 
  const monday = new Date(today); 
  monday.setDate(today.getDate()-diff);

  let html = '<table><thead><tr><th>Day</th><th>Date</th><th>Status</th></tr></thead><tbody>';

  for(let i=0;i<6;i++){
    const d = new Date(monday); 
    d.setDate(monday.getDate()+i);

    const y=d.getFullYear(), mo=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
    const keyAM=`${y}-${mo}-${da}_AM`; 
    const keyPM=`${y}-${mo}-${da}_PM`;

    const recAM = data.attendance[keyAM] ? data.attendance[keyAM].present.includes(pin) : false;
    const recPM = data.attendance[keyPM] ? data.attendance[keyPM].present.includes(pin) : false;
    const present = recAM || recPM;

    const status = present ? `<span class="status-p">P</span>` : `<span class="status-a">A</span>`;

    html += `<tr><td>${['Mon','Tue','Wed','Thu','Fri','Sat'][i]}</td><td>${da}-${mo}-${y}</td><td>${status}</td></tr>`;
  }

  html += '</tbody></table>'; 
  return html;
}

/* Export CSV */
function exportCSV(){
  const year=Number(document.getElementById('view-year').value); 
  const data=getData(); 
  const studs = data.students.filter(s=>s.year===year); 
  const totalWorking = getTotalWorkingDaysSoFar(); 
  let csv='PIN,Name,DaysPresent,TotalWorkingDays,Percentage\n'; 

  studs.forEach(s=>{
    let present=0; 
    for(const k in data.attendance){ 
      if(data.attendance[k].present.includes(s.pin)) present++; 
    }
    const percent = totalWorking===0 ? 0 : Math.round((present/totalWorking)*100); 
    csv += `${s.pin},"${s.name}",${present},${totalWorking},${percent}%\n`; 
  });

  const blob=new Blob([csv],{type:'text/csv'}); 
  const url=URL.createObjectURL(blob); 
  const a=document.createElement('a'); 
  a.href=url; 
  a.download=`attendance_year${year}.csv`; 
  a.click(); 
  URL.revokeObjectURL(url);
}

/* Init */
backHome(); 
renderEditTable();
window._debug={getData,saveData};

</script>

</body>
</html>
